ggplot(summarySE(data_sel, measurevar="n_intact_seeds", groupvars=c("year")),
aes(x=as.integer(as.character(year)),y=n_intact_seeds))+geom_point()+
geom_errorbar(aes(ymin=n_intact_seeds-se, ymax=n_intact_seeds+se), width=.3)+ geom_point(size=3)+
scale_x_continuous(breaks=seq(1987,2017,2))+
xlab(NULL)+ylab("\nNumber of intact seeds")+ggtitle("C)")+my_theme(),
# Linear selection gradients for FFD
ggplot(subset(selgrads_FFD,term=="FFD_std"),
aes(x=as.integer(as.character(year)), y=estimate,colour=term,shape=sig))+
geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.3,position=position_dodge(0.5))+
geom_point(size=3,position=position_dodge(0.5))+
scale_colour_manual(values = c("Black", "#999999"))+scale_shape_manual(values=c(1,19))+
scale_x_continuous(breaks=seq(1987,2017,2))+
xlab("Year")+ylab("Selection gradient\nfor first flowering date")+
geom_hline(yintercept=0,size=0.5,colour="grey",linetype="dashed")+ggtitle("D)")+my_theme(),
ncol=1)
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/fig1.tiff",
plot=fig1,device="tiff",width=25,height=36,units="cm",dpi=400)
figS1<-grid.arrange(
ggplot(summarySE(subset(subset(weather,year>1960),month==3),measurevar="min", groupvars=c("year")),
aes(x=as.integer(as.character(year)),y=min))+
geom_errorbar(aes(ymin=min-se, ymax=min+se), width=.1)+geom_point(size=3)+
geom_smooth(method="lm",color="black")+ggtitle("A)")+
xlab(NULL)+ylab("Min daily temperature March")+my_theme()+
theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(-10,-8,-6,-4,-2,0,2,4,6,8))+
scale_x_continuous(breaks=seq(1961,2017,4)),
ggplot(summarySE(subset(subset(weather,year>1960),month==4),measurevar="min", groupvars=c("year")),
aes(x=as.integer(as.character(year)),y=min))+
geom_errorbar(aes(ymin=min-se, ymax=min+se), width=.1)+geom_point(size=3)+
geom_smooth(method="lm",color="black")+ggtitle("B)")+
xlab(NULL)+ylab("Min daily temperature April")+my_theme()+
theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(-10,-8,-6,-4,-2,0,2,4,6,8))+
scale_x_continuous(breaks=seq(1961,2017,4)),
ggplot(summarySE(subset(subset(weather,year>1960),month==5),measurevar="min", groupvars=c("year")),
aes(x=as.integer(as.character(year)),y=min))+
geom_errorbar(aes(ymin=min-se, ymax=min+se), width=.1)+geom_point(size=3)+
geom_smooth(method="lm",color="black")+ggtitle("C)")+
xlab("Year")+ylab("Min daily temperature May")+my_theme()+
theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(-10,-8,-6,-4,-2,0,2,4,6,8))+
scale_x_continuous(breaks=seq(1961,2017,4)),
ncol=1)
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/figS1.tiff",
plot=figS1,device="tiff",width=25,height=33,units="cm",dpi=400)
figS2<-grid.arrange(
ggplot(summarySE(subset(subset(weather,year>1960),month==3),measurevar="mean", groupvars=c("year")),
aes(x=as.integer(as.character(year)),y=mean))+
geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+geom_point(size=3)+
geom_smooth(method="lm",color="black")+ggtitle("A)")+
xlab(NULL)+ylab("Mean daily temperature March")+my_theme()+
theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(-10,-8,-6,-4,-2,0,2,4,6,8))+
scale_x_continuous(breaks=seq(1961,2017,4)),
ggplot(summarySE(subset(subset(weather,year>1960),month==4),measurevar="mean", groupvars=c("year")),
aes(x=as.integer(as.character(year)),y=mean))+
geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+geom_point(size=3)+
geom_smooth(method="lm",color="black")+ggtitle("B)")+
xlab(NULL)+ylab("Mean daily temperature April")+my_theme()+
theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(-10,-8,-6,-4,-2,0,2,4,6,8))+
scale_x_continuous(breaks=seq(1961,2017,4)),
ggplot(summarySE(subset(subset(weather,year>1960),month==5),measurevar="mean", groupvars=c("year")),
aes(x=as.integer(as.character(year)),y=mean))+
geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+geom_point(size=3)+
geom_smooth(method="lm",color="black")+ggtitle("C)")+
xlab("Year")+ylab("Mean daily temperature May")+my_theme()+
theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(8,10,12,14,16))+
scale_x_continuous(breaks=seq(1961,2017,4)),
ncol=1)
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/figS2.tiff",
plot=figS2,device="tiff",width=25,height=33,units="cm",dpi=400)
figS3<-grid.arrange(
ggplot(summarySE(subset(subset(weather,year>1960),month==3),measurevar="max", groupvars=c("year")),
aes(x=as.integer(as.character(year)),y=max))+
geom_errorbar(aes(ymin=max-se, ymax=max+se), width=.1)+geom_point(size=3)+
geom_smooth(method="lm",color="black")+ggtitle("A)")+
xlab(NULL)+ylab("Max daily temperature March")+my_theme()+
theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(0,2,4,6,8,10))+
scale_x_continuous(breaks=seq(1961,2017,4)),
ggplot(summarySE(subset(subset(weather,year>1960),month==4),measurevar="max", groupvars=c("year")),
aes(x=as.integer(as.character(year)),y=max))+
geom_errorbar(aes(ymin=max-se, ymax=max+se), width=.1)+geom_point(size=3)+
geom_smooth(method="lm",color="black")+ggtitle("B)")+
xlab(NULL)+ylab("Max daily temperature April")+my_theme()+
theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(0,2,4,6,8,10,12,14,16))+
scale_x_continuous(breaks=seq(1961,2017,4)),
ggplot(summarySE(subset(subset(weather,year>1960),month==5),measurevar="max", groupvars=c("year")),
aes(x=as.integer(as.character(year)),y=max))+
geom_errorbar(aes(ymin=max-se, ymax=max+se), width=.1)+geom_point(size=3)+
geom_smooth(method="lm",color="black")+ggtitle("C)")+
xlab("Year")+ylab("Max daily temperature May")+my_theme()+
theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(12,14,16,18,20,22))+
scale_x_continuous(breaks=seq(1961,2017,4)),
ncol=1)
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/figS3.tiff",
plot=figS3,device="tiff",width=25,height=33,units="cm",dpi=400)
figS4<-grid.arrange(
ggplot(aggregate(precipitation ~ year,data= subset(weather,month==3),FUN=sum))+
aes(x=as.integer(as.character(year)),y=precipitation)+
geom_bar(stat="identity",position = "identity")+
xlab(NULL)+ylab("Precipitation March")+ggtitle("A)")+my_theme()+
scale_y_continuous(labels=function(x) format(x, width=3))+
theme(plot.title=element_text(hjust=-0.07,vjust=0))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_x_continuous(breaks=seq(1945,2017,4)),
ggplot(aggregate(precipitation ~ year+month,data= subset(weather,month==4),FUN=sum))+
aes(x=as.integer(as.character(year)),y=precipitation)+
geom_bar(stat="identity",position = "identity")+
xlab(NULL)+ylab("Precipitation April")+ggtitle("D)")+my_theme()+
scale_y_continuous(labels=function(x) format(x, width=3))+
theme(plot.title=element_text(hjust=-0.07,vjust=0))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_x_continuous(breaks=seq(1945,2017,4)),
ggplot(aggregate(precipitation ~ year+month,data= subset(weather,month==5),FUN=sum))+
aes(x=as.integer(as.character(year)),y=precipitation)+
geom_bar(stat="identity",position = "identity")+
xlab("Year")+ylab("Precipitation May")+ggtitle("C)")+my_theme()+
scale_y_continuous(labels=function(x) format(x, width=3))+
theme(plot.title=element_text(hjust=-0.07,vjust=0))+
theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
scale_x_continuous(breaks=seq(1945,2017,4)),
ncol=1)
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/figS4.tiff",
plot=figS4,device="tiff",width=25,height=33,units="cm",dpi=400)
# Variables to use
subset1<-data_sel[c(2,3,42,158:160,170:172,182:184,194:196)]
subset1[,3:15]<-scale(subset1[,3:15])
globmod_FFD<-lmer(FFD ~ max_3+max_4+max_5+mean_3+mean_4+mean_5+min_3+min_4+min_5+
precipitation_3+precipitation_4+precipitation_5+n_fl+(1|id),
data = subset1,REML=FALSE,na.action="na.fail")
# Excluding collinear variables with r > 0.5
smat1 <- abs(cor(subset1[, -c(1,2,3)])) <= .5 # TRUE: cor<=0.5,FALSE: cor>0.5
smat1[!lower.tri(smat1)] <- NA
clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust1 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust1, "subset1")
clusterEvalQ(clust1, library(lme4))
modsel_FFD<-pdredge(globmod_FFD,fixed=c("n_fl"),subset=smat1,cluster=clust1)
summary(model.avg(modsel_FFD,subset=delta<2)) # Summary averaged model
importance(modsel_FFD) # Variable importance
r.squaredGLMM(get.models(modsel_FFD,subset=1)$"1585") #R square of best model
summary(lmer(FFD ~ scale(mean_4)+scale(mean_5)+
scale(precipitation_3)+scale(precipitation_4)+scale(n_fl)+
as.integer(as.character(year))+(1|id),data = data_sel,
REML=FALSE,na.action="na.fail"))
r.squaredGLMM(lmer(FFD ~ scale(mean_4)+scale(mean_5)+
scale(precipitation_3)+scale(precipitation_4)+scale(n_fl)+
as.integer(as.character(year))+(1|id),data = data_sel,
REML=FALSE,na.action="na.fail"))
fig2<-grid.arrange(
ggplot(data_sel,aes(x=mean_4,y=FFD))+ggtitle("A)")+
geom_point(size=1)+geom_smooth(method="lm",color="black",se=F)+
xlab("Mean daily temperature April")+ylab(NULL)+my_theme()+
theme(plot.title=element_text(hjust=-0.13,vjust=2)),
ggplot(data_sel,aes(x=mean_5,y=FFD))+ggtitle("B)")+
geom_point(size=1)+geom_smooth(method="lm",color="black",se=F)+
xlab("Mean daily temperature May")+ylab(NULL)+my_theme()+
theme(axis.text.y=element_text(color="white"))+
theme(plot.title=element_text(hjust=-0.13,vjust=2)),
ggplot(data_sel,aes(x=precipitation_3,y=FFD))+ggtitle("C)")+
geom_point(size=1)+geom_smooth(method="lm",color="black",se=F)+
xlab("Sum of precipitation March")+ylab(NULL)+my_theme()+
theme(axis.text.y=element_text(color="white"))+
theme(plot.title=element_text(hjust=-0.13,vjust=2)),    ggplot(data_sel,aes(x=precipitation_4,y=FFD))+ggtitle("D)")+
geom_point(size=1)+geom_smooth(method="lm",color="black",se=F)+
xlab("Sum of precipitation April")+ylab(NULL)+my_theme()+
theme(axis.text.y=element_text(color="white"))+
theme(plot.title=element_text(hjust=-0.13,vjust=2)),
ncol=4,left=textGrob("First flowering date",just="center",hjust=0.42,
gp=gpar(fontsize=16,fontfamily="serif"),rot = 90))
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/fig2.tiff",
plot=fig2,device="tiff",width=38,height=9,units="cm",dpi=600)
summary(lm(FFD_mean~scale(mean_4)+scale(mean_5)+
scale(precipitation_3)+scale(precipitation_4),data=mean_weather4))
## Including year (Table S2)
summary(lm(FFD_mean~scale(mean_4)+scale(mean_5)+
scale(precipitation_3)+scale(precipitation_4)+
as.integer(as.character(year)),data=mean_weather4))
summary(lm(date_10~scale(mean_4)+scale(mean_5)+
scale(precipitation_3)+scale(precipitation_4),data=mean_weather4))
## Including year (Table S2)
summary(lm(date_10~scale(mean_4)+scale(mean_5)+
scale(precipitation_3)+scale(precipitation_4)+
as.integer(as.character(year)),data=mean_weather4))
summary(lm(date_90~scale(mean_4)+scale(mean_5)+
scale(precipitation_3)+scale(precipitation_4),data=mean_weather4))
## Including year (Table S2)
summary(lm(date_90~scale(mean_4)+scale(mean_5)+
scale(precipitation_3)+scale(precipitation_4)+
as.integer(as.character(year)),data=mean_weather4))
summary(lm(days_90_10~scale(mean_4)+scale(mean_5)+
scale(precipitation_3)+scale(precipitation_4),data=mean_weather4))
## Including year  (Table S2)
summary(lm(days_90_10~scale(mean_4)+scale(mean_5)+
scale(precipitation_3)+scale(precipitation_4)+
as.integer(as.character(year)),data=mean_weather4))
fig3<-grid.arrange(
ggplot(mean_weather4)+ggtitle("A)")+
geom_point(aes(x=mean_4,y=date_10),shape=24)+
geom_smooth(aes(x=mean_4,y=date_10),method="lm",color="black",lty="dashed",se=F)+
geom_point(aes(x=mean_4,y=FFD_mean),shape=19)+
geom_smooth(aes(x=mean_4,y=FFD_mean),method="lm",color="black",se=F)+
geom_point(aes(x=mean_4,y=date_90),shape=8)+
geom_smooth(aes(x=mean_4,y=date_90),method="lm",color="black",lty="dotted",se=F)+
xlab("Mean daily temperature April")+ylab(NULL)+my_theme()+
scale_y_continuous(limits=c(40,80))+
theme(plot.title=element_text(hjust=-0.13,vjust=1))+
theme(plot.margin = unit(c(0.07,0.2,0.07,0.2), "cm")),
ggplot(mean_weather4)+ggtitle("B)")+
geom_point(aes(x=mean_5,y=date_10),shape=24)+
geom_smooth(aes(x=mean_5,y=date_10),method="lm",color="black",lty="dashed",se=F)+
geom_point(aes(x=mean_5,y=FFD_mean),shape=19)+
geom_smooth(aes(x=mean_5,y=FFD_mean),method="lm",color="black",se=F)+
geom_point(aes(x=mean_5,y=date_90),shape=8)+
geom_smooth(aes(x=mean_5,y=date_90),method="lm",color="black",lty="dotted",se=F)+
xlab("Mean daily temperature May")+ylab(NULL)+my_theme()+
scale_y_continuous(limits=c(40,80))+theme(axis.text.y=element_text(color="white"))+
theme(plot.title=element_text(hjust=-0.13,vjust=1))+
theme(plot.margin = unit(c(0.07,0.2,0.07,0.2), "cm")),
ggplot(mean_weather4)+ggtitle("C)")+
geom_point(aes(x=mean_4,y=days_90_10),shape=19)+
geom_smooth(aes(x=mean_4,y=days_90_10),method="lm",color="black",se=F)+
xlab("Mean daily temperature April")+ylab("Duration of flowering season")+my_theme()+
theme(plot.title=element_text(hjust=-0.13,vjust=1))+
theme(plot.margin = unit(c(0.07,0.2,0.07,0.2), "cm")),
ncol=3,left=textGrob("Day from vernal equinox",
gp=gpar(fontsize=16,fontfamily="serif"),rot = 90,hjust=0.46))
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/fig3.tiff",
plot=fig3,device="tiff",width=28,height=9,units="cm",dpi=600)
# Variables to use
subset2<-data_sel[c(3,20,42,158:160,170:172,182:184,194:196)]
subset2[,c(3:15)]<-scale(subset2[,c(3:15)])
globmod_fitness<-lmer(n_intact_seeds ~ max_3+max_4+max_5+mean_3+mean_4+mean_5+
min_3+min_4+min_5+precipitation_3+precipitation_4+precipitation_5+
n_fl+(1|id),data = subset2,REML=FALSE,na.action="na.fail")
# Excluding collinear variables with r > 0.5
smat2 <- abs(cor(subset2[, -c(1:3)])) <= .5 # TRUE: cor<=0.5,FALSE: cor>0.5
smat2[!lower.tri(smat2)] <- NA
clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust1 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust1, "subset2")
clusterEvalQ(clust1, library(lme4))
modsel_fitness<-pdredge(globmod_fitness,subset=smat2,fixed="n_fl",cluster=clust1)
summary(model.avg(modsel_fitness,subset=delta<2)) # Summary averaged model
importance(modsel_fitness) # Variable importance
r.squaredGLMM(get.models(modsel_fitness,subset=1)$"1794") #R square of best model
#Using a model with significant variables in model averaging
effect1<-data.frame(effect(term="max_4",mod=lmer(n_intact_seeds~
max_4+min_5+precipitation_3+precipitation_4+n_fl+(1|id),
data=data_sel,REML=FALSE,na.action="na.fail"),
xlevels=list(max_4=seq(7.0,13.6,0.1))))
effect2<-data.frame(effect(term="min_5",mod=lmer(n_intact_seeds~                                        max_4+min_5+precipitation_3+precipitation_4+n_fl+(1|id),
data=data_sel,REML=FALSE,na.action="na.fail"),
xlevels=list(min_5=seq(3.9,8.0,0.1))))
effect3<-data.frame(effect(term="precipitation_3",mod=lmer(n_intact_seeds~
max_4+min_5+precipitation_3+precipitation_4+
n_fl+(1|id),data=data_sel,REML=FALSE,na.action="na.fail"),
xlevels=list(precipitation_3=seq(4.8,78.2,1))))
effect4<-data.frame(effect(term="precipitation_4",mod=lmer(n_intact_seeds~
max_4+min_5+precipitation_3+precipitation_4+
n_fl+(1|id),data=data_sel,REML=FALSE,na.action="na.fail"),
xlevels=list(precipitation_4=seq(3.7,79.8,1))))
figS5<-grid.arrange(
ggplot(effect1, aes(max_4,fit))+ggtitle("A)")+
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.5,fill="grey")+
geom_smooth(method="lm",se=T,size=1,color="black",aes(max_4,fit))+
xlab("Maximum daily temperature April")+ylab(NULL)+my_theme()+
theme(plot.margin = unit(c(0.07,0.07,0.07,0.07), "cm"))+
theme(plot.title=element_text(hjust=-0.12,vjust=-2))+
scale_y_continuous(limits=c(1,11),breaks=c(2,4,6,8,10)),
ggplot(effect2, aes(min_5,fit))+ggtitle("B)")+
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.5,fill="grey")+
geom_smooth(method="lm",se=T,size=1,color="black",aes(min_5,fit))+
xlab("Minimum daily temperature May")+ylab(NULL)+my_theme()+
theme(plot.margin = unit(c(0.07,0.07,0.07,0.07), "cm"))+
theme(plot.title=element_text(hjust=-0.12,vjust=-2))+
scale_y_continuous(limits=c(1,11),breaks=c(2,4,6,8,10))+
theme(axis.text.y=element_text(color="white")),
ggplot(effect3, aes(precipitation_3,fit))+ggtitle("C)")+
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.5,fill="grey")+
geom_smooth(method="lm",se=T,size=1,color="black",aes(precipitation_3,fit))+
xlab("Sum of precipitation March")+ylab(NULL)+my_theme()+
theme(plot.margin = unit(c(0.07,0.07,0.07,0.07), "cm"))+
theme(plot.title=element_text(hjust=-0.12,vjust=-2))+
scale_y_continuous(limits=c(1,11),breaks=c(2,4,6,8,10))+
theme(axis.text.y=element_text(color="white")),
ggplot(effect4, aes(precipitation_4,fit))+ggtitle("D)")+
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.5,fill="grey")+
geom_smooth(method="lm",se=T,size=1,color="black",aes(precipitation_4,fit))+
xlab("Sum of precipitation April")+ylab(NULL)+my_theme()+
theme(plot.margin = unit(c(0.07,0.07,0.07,0.07), "cm"))+
theme(plot.title=element_text(hjust=-0.12,vjust=-2))+
scale_y_continuous(limits=c(1,11),breaks=c(2,4,6,8,10))+
theme(axis.text.y=element_text(color="white")),
ncol=4,left=textGrob("Number of intact seeds",just="center",hjust=0.48,
gp=gpar(fontsize=16,fontfamily="serif"),rot = 90))
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/figS5.tiff",
plot=figS5,device="tiff",width=35,height=9,units="cm",dpi=600)
Anova(lmer(n_intact_seeds_rel ~ FFD_std+FFD_std:year+(1|id),data = data_sel),type="II")
#Indirect selection for early flowering differs among years
Anova(lmer(n_intact_seeds_rel ~ FFD_std+FFD_std:year+n_fl_std+(1|id),data = data_sel),type="II")
#Direct selection for early flowering differs among years
# Variables to use
subset3<-data_sel[c(3,44:45,158:160,170:172,182:184,194:196)]
subset3[,c(4:15)]<-scale(subset3[,c(4:15)])
globmod_total_selection<-lmer(n_intact_seeds_rel ~ FFD_std+
FFD_std:max_3+FFD_std:max_4+FFD_std:max_5+
FFD_std:mean_3+FFD_std:mean_4+FFD_std:mean_5+
FFD_std:min_3+FFD_std:min_4+FFD_std:min_5+
FFD_std:precipitation_3+FFD_std:precipitation_4+
FFD_std:precipitation_5+(1|id),
data = subset3,REML=FALSE,na.action="na.fail")
# Excluding collinear variables with r > 0.5
smat3 <- abs(cor(subset3[, -c(1:3)])) <= .5 # TRUE: cor<=0.5,FALSE: cor>0.5
smat3[!lower.tri(smat3)] <- NA
rownames(smat3)<-paste("FFD_std:", names(smat3[1,1:12]),sep="")
colnames(smat3)<-paste("FFD_std:", names(smat3[1,1:12]),sep="")
clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust1 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust1, "subset3")
clusterEvalQ(clust1, library(lme4))
modsel_total_selection<-pdredge(globmod_total_selection,subset=smat3,fixed=c("FFD_std"),
cluster=clust1)
summary(model.avg(modsel_total_selection,subset=delta<2)) # Summary averaged model
importance(modsel_total_selection) # Variable importance
r.squaredGLMM(get.models(modsel_total_selection,subset=1)$"1696") #R square of best model
# Anova (Table 4A) with model including variables that were significant in the averaged model
Anova(lmer(n_intact_seeds_rel ~ FFD_std+FFD_std:min_4+FFD_std:precipitation_3+FFD_std:precipitation_4+
(1|id),data = subset3,REML=FALSE,na.action="na.fail"))
# Variables to use
subset4<-data_sel[c(3,44:46,158:160,170:172,182:184,194:196)]
subset4[,c(5:16)]<-scale(subset4[,c(5:16)])
globmod_direct_selection<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+
FFD_std:max_3+FFD_std:max_4+FFD_std:max_5+
FFD_std:mean_3+FFD_std:mean_4+FFD_std:mean_5+
FFD_std:min_3+FFD_std:min_4+FFD_std:min_5+
FFD_std:precipitation_3+FFD_std:precipitation_4+
FFD_std:precipitation_5+(1|id),
data = subset4,REML=FALSE,na.action="na.fail")
# Excluding collinear variables with r > 0.5
smat4 <- abs(cor(subset4[, -c(1:4)])) <= .5 # TRUE: cor<=0.5,FALSE: cor>0.5
smat4[!lower.tri(smat4)] <- NA
rownames(smat4)<-paste("FFD_std:", names(smat4[1,1:12]),sep="")
colnames(smat4)<-paste("FFD_std:", names(smat4[1,1:12]),sep="")
clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust1 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust1, "subset4")
clusterEvalQ(clust1, library(lme4))
modsel_direct_selection<-pdredge(globmod_direct_selection,subset=smat4,
fixed=c("FFD_std","n_fl_std"),cluster=clust1)
summary(model.avg(modsel_direct_selection,subset=delta<2)) # Summary averaged model
importance(modsel_direct_selection) # Variable importance
r.squaredGLMM(get.models(modsel_direct_selection,subset=1)$"1696") #R square of best model
# Anova (Table 4A) with model including variables that were significant in the averaged model
Anova(lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+FFD_std:min_4+FFD_std:precipitation_3+FFD_std:precipitation_4+
(1|id),data = subset4,REML=FALSE,na.action="na.fail"))
subset4<-data_sel[c(3,44:46,158:160,170:172,182:184,194:196)]
modsel_sig<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+FFD_std:min_4+FFD_std:precipitation_3+
FFD_std:precipitation_4+(1|id),
data = subset4,REML=FALSE,na.action="na.fail")
interaction1<-data.frame(effect(term="FFD_std:min_4",mod=modsel_sig,
xlevels=list(FFD_std=seq(-3.9,4.2,0.1),
min_4=seq(-0.1,3.7,0.1))))
interaction1$fit_mod<-with(interaction1,ifelse(fit<0,0,fit))
interaction2<-data.frame(effect(term="FFD_std:precipitation_3",mod=modsel_sig,
xlevels=list(FFD_std=seq(-3.9,4.2,0.1),
precipitation_3=seq(4.8,78.2,1))))
interaction2$fit_mod<-with(interaction2,ifelse(fit<0,0,fit))
myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
p1<-ggplot(interaction1, aes(FFD_std,fit_mod, group = as.factor(min_4)))+
geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=min_4))+
xlab("Standardized first flowering date")+ylab(NULL)+ggtitle("A)")+
my_theme()+scale_colour_gradientn(colours = myPalette(100))+
theme(legend.position="top")+labs(colour="Minimum daily\ntemperature April")+
theme(plot.margin = unit(c(0.1,0.3,0.1,0.3), "cm"))+
theme(plot.title=element_text(hjust=-0.10,vjust=-16))+
scale_y_continuous(limit=c(0,3.2))
myPalette <- colorRampPalette(brewer.pal(11, "Blues"))
p2<-ggplot(interaction2, aes(FFD_std,fit_mod, group = as.factor(precipitation_3)))+
geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=precipitation_3))+
xlab("Standardized first flowering date")+ylab(NULL)+ggtitle("B)")+
my_theme()+scale_colour_gradientn(colours = myPalette(100))+
theme(legend.position="top")+labs(colour="Sum of\nprecipitation March")+
theme(axis.text.y=element_text(color="white"))+
theme(plot.margin = unit(c(0.1,0.3,0.1,0.3), "cm"))+
theme(plot.title=element_text(hjust=-0.10,vjust=-16))+
scale_y_continuous(limit=c(0,3.2))
fig4<-grid.arrange(p1,p2,ncol=2,
left=textGrob("Relative number of intact seeds",
just="center",hjust=0.63,
gp=gpar(fontsize=16,fontfamily="serif"),rot = 90))
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/fig4.tiff",
plot=fig4,device="tiff",width=19,height=11,units="cm",dpi=600)
data_seldiff<-subset(seldiffs_FFD,term=="FFD_std")[c(1,3:4)]
names(data_seldiff)<-c("year","seldiff","SE_seldiff")
data_seldiff<-merge(data_seldiff,unique(data_sel[c(1,183,194:195)]))
myprior <- list(R = list(V=1, nu=0.002))
model_seldiff<-MCMCglmm(seldiff~min_4+precipitation_3+precipitation_4,
mev=data_seldiff$SE_seldiff^2,data=data_seldiff,family="gaussian",
nitt=500000,burnin=10000,thin=10,prior=myprior,verbose=F)
summary(model_seldiff)
head(model_seldiff$Sol)
head(model_seldiff$VCV)
nMCMC_seldiff<-dim(model_seldiff$Sol)[1] # Sample size
# To contain posterior distribution of the variance in seldiffs associated with the environment
post.Var_seldiff<-array(dim=nMCMC_seldiff)
# The posterior samples of the partial regression coefficients of seldiffs on the predictor
# variables relate to the variance in seldiffs associated with the multivariate environment
# according to: V(Y) = T(B) %*% V(X) %*% B
# (standard expression for a variance of a linear transformation)
# V(Y) = variance of selection differentials arising from environmental variation
# V(X) = covariance matrix of the environmental variable
# B = linear transformation of X onto Y (partial regression coefficients)
# Apply this transformation to each posterior sample to generate a posterior distribution of
# the variance in seldiffs associated with environmental variables
# This is the numerator of equation 12 in Hunter et al. 2018, for calculating
# the proportion of the total variation in selection attributed to the environmental
# component of the model. The denominator is this quantity plus the residual variance.
# Calculate the variance, over all posterior samples
Sigma_seldiff<-var(as.matrix(model_seldiff$X[,2:4])) # Covariance matrix of environmental vars
for(i in 1:nMCMC_seldiff){
post.Var_seldiff[i]<- t(model_seldiff$Sol[i,2:4]) %*% Sigma_seldiff %*%model_seldiff$Sol[i,2:4]
# Variance of seldiffs arising from environmental variation
}
# Two flavours of the estimate of the variance associated with the climate variables
# (Numerator of equation 12)
mean(post.Var_seldiff)
posterior.mode(as.mcmc(post.Var_seldiff))
# 95% credible interval of the variance
HPDinterval(as.mcmc(post.Var_seldiff))
# Visualise
par(mfrow=c(1,2))
plot(density(post.Var_seldiff))
# Two flavours of the estimate of the proportion of variance associated with the climate variables
# (Equation 12 in paper)
mean(post.Var_seldiff/(post.Var_seldiff+model_seldiff$VCV[,2])) # 0.6964514
posterior.mode(as.mcmc(post.Var_seldiff/(post.Var_seldiff+model_seldiff$VCV[,2]))) # 0.8768223
# 95% credible interval of the variance
HPDinterval(as.mcmc(post.Var_seldiff/(post.Var_seldiff+model_seldiff$VCV[,2])))
# visualise
plot(density(post.Var_seldiff/(post.Var_seldiff+model_seldiff$VCV[,2])))
data_selgrad<-subset(selgrads_FFD,term=="FFD_std")[c(1,3:4)]
names(data_selgrad)<-c("year","selgrad","SE_selgrad")
data_selgrad<-merge(data_selgrad,unique(data_sel[c(1,183,194:195)]))
myprior <- list(R = list(V=1, nu=0.002))
model_selgrad<-MCMCglmm(selgrad~min_4+precipitation_3+precipitation_4,
mev=data_selgrad$SE_selgrad^2,data=data_selgrad,family="gaussian",
nitt=500000,burnin=10000,thin=10,prior=myprior,verbose=F)
summary(model_selgrad)
head(model_selgrad$Sol)
head(model_selgrad$VCV)
nMCMC_selgrad<-dim(model_selgrad$Sol)[1] # Sample size
# To contain posterior distribution of the variance in selgrads associated with the environment
post.Var_selgrad<-array(dim=nMCMC_selgrad)
# The posterior samples of the partial regression coefficients of selgrads on the predictor
# variables relate to the variance in selgrads associated with the multivariate environment
# according to: V(Y) = T(B) %*% V(X) %*% B
# (standard expression for a variance of a linear transformation)
# V(Y) = variance of selection graderentials arising from environmental variation
# V(X) = covariance matrix of the environmental variable
# B = linear transformation of X onto Y (partial regression coefficients)
# Apply this transformation to each posterior sample to generate a posterior distribution of
# the variance in selgrads associated with environmental variables
# This is the numerator of equation 12 in Hunter et al. 2018, for calculating
# the proportion of the total variation in selection attributed to the environmental
# component of the model. The denominator is this quantity plus the residual variance.
# Calculate the variance, over all posterior samples
Sigma_selgrad<-var(as.matrix(model_selgrad$X[,2:4])) # Covariance matrix of environmental vars
for(i in 1:nMCMC_selgrad){
post.Var_selgrad[i]<- t(model_selgrad$Sol[i,2:4]) %*% Sigma_selgrad %*%model_selgrad$Sol[i,2:4]
# Variance of selgrads arising from environmental variation
}
# Two flavours of the estimate of the variance associated with the climate variables
# (Numerator of equation 12)
mean(post.Var_selgrad)
posterior.mode(as.mcmc(post.Var_selgrad))
# 95% credible interval of the variance
HPDinterval(as.mcmc(post.Var_selgrad))
# Visualise
par(mfrow=c(1,2))
plot(density(post.Var_selgrad))
# Two flavours of the estimate of the proportion of variance associated with the climate variables
# (Equation 12 in paper)
mean(post.Var_selgrad/(post.Var_selgrad+model_selgrad$VCV[,2])) # 0.6756869
posterior.mode(as.mcmc(post.Var_selgrad/(post.Var_selgrad+model_selgrad$VCV[,2]))) # 0.8413189
# 95% credible interval of the variance
HPDinterval(as.mcmc(post.Var_selgrad/(post.Var_selgrad+model_selgrad$VCV[,2])))
# visualise
plot(density(post.Var_selgrad/(post.Var_selgrad+model_selgrad$VCV[,2])))
head(alldata_weather_subs)
str(alldata_weather_subs)
head(alldata_agg)
nrow(alldata_agg)
nrow(alldata_weather_subs)
nrow(data_sel)
write.table(data_sel,
file="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/data_sel.csv",
sep="\t",dec=",",col.names=T,row.names=F)
