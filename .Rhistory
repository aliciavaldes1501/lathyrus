#See them per years
data.frame(table(subset(alldata,data==1&is.na(FFD))$year))
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1987) #0
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1988) #6 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1989) #30 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1990) #4 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1991) #1 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1992) #1 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1993) #3 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1994) #8 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1995) #35
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1996) #0
#Pls with data=1 and cum_n_fl missing
nrow(subset(alldata,data==1&period=="new"&is.na(cum_n_fl))) #24 from new period-OK, to be imputed from shoot_vol
nrow(subset(alldata,data==1&period=="old"&is.na(cum_n_fl))) #51 from old period-All have shoot_vol, could also impute fl from there
subset(alldata,cum_n_fl==0) #No pls with 0 flowers
#Pls with data=1 and grazing missing
subset(alldata,data==1&is.na(grazing)) #No
subset(alldata,data==1&is.na(n_fr)) #0
subset(alldata,data==1&is.na(n_ovules)) #159, 1987-88-89-90-91-92-93-94
#Calculate mean n ovules per fr for each of these years --> USE FOR CALCULATING N_OVULES
n_ovules_per_fr<-with(subset(alldata,year==1987|year==1988|year==1989|year==1990|year==1991|year==1992|year==1993|year==1994|year==1995),aggregate(n_ovules/n_fr~year, FUN=mean))
alldata$n_ovules<-ifelse(is.na(alldata$n_ovules)&alldata$year=="1987",n_ovules_per_fr$`n_ovules/n_fr`[1]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1988",n_ovules_per_fr$`n_ovules/n_fr`[2]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1989",n_ovules_per_fr$`n_ovules/n_fr`[3]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1990",n_ovules_per_fr$`n_ovules/n_fr`[4]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1991",n_ovules_per_fr$`n_ovules/n_fr`[5]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1992",n_ovules_per_fr$`n_ovules/n_fr`[6]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1993",n_ovules_per_fr$`n_ovules/n_fr`[7]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1994",n_ovules_per_fr$`n_ovules/n_fr`[8]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1995",n_ovules_per_fr$`n_ovules/n_fr`[9]*alldata$n_fr,
alldata$n_ovules)))))))))
with(subset(alldata,year=="1987"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1988"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1989"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1990"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1991"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1992"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1993"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1994"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1995"),hist(n_ovules,breaks=200))
mean(ov_per_fr[!is.na(ov_per_fr)]) #Similar
subset(alldata,data==1&is.na(total_n_seeds)) #66
subset(alldata,data==1&is.na(total_n_intact_seeds)) #66
#Calculate mean total_n_seeds per fr for each of these years --> USE FOR CALCULATING total_n_seeds
total_n_seeds_per_fr<-with(subset(alldata,year==1990|year==1991|year==1992|year==1993|year==1994|year==1995),
aggregate(total_n_seeds/n_fr~year, FUN=mean))
alldata$total_n_seeds<-ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1990",total_n_seeds_per_fr$`total_n_seeds/n_fr`[1]*alldata$n_fr,
ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1991",total_n_seeds_per_fr$`total_n_seeds/n_fr`[2]*alldata$n_fr,
ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1992",total_n_seeds_per_fr$`total_n_seeds/n_fr`[3]*alldata$n_fr,
ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1993",total_n_seeds_per_fr$`total_n_seeds/n_fr`[4]*alldata$n_fr,
ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1994",total_n_seeds_per_fr$`total_n_seeds/n_fr`[5]*alldata$n_fr,
ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1995",total_n_seeds_per_fr$`total_n_seeds/n_fr`[6]*alldata$n_fr,
alldata$total_n_seeds))))))
hist(alldata$total_n_seeds)
#Calculate mean total_n_intact_seeds per fr for each of these years --> USE FOR CALCULATING total_n_intact_seeds
total_n_intact_seeds_per_fr<-with(subset(alldata,year==1990|year==1991|year==1992|year==1993|year==1994|year==1995),
aggregate(total_n_intact_seeds/n_fr~year, FUN=mean))
alldata$total_n_intact_seeds<-ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1990",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[1]*alldata$n_fr,
ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1991",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[2]*alldata$n_fr,
ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1992",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[3]*alldata$n_fr,
ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1993",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[4]*alldata$n_fr,
ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1994",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[5]*alldata$n_fr,
ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1995",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[6]*alldata$n_fr,
alldata$total_n_intact_seeds))))))
hist(alldata$total_n_intact_seeds)
subset(alldata,total_n_seeds>n_ovules) #none
subset(alldata,n_fr>0&total_n_seeds==0) #none
subset(alldata,n_fr>0&is.na(total_n_seeds)) #none
subset(alldata,total_n_intact_seeds>total_n_seeds) #none
subset(alldata,total_n_seeds>0&is.na(total_n_intact_seeds)) #none
subset(alldata,total_n_intact_seeds>0&is.na(total_n_seeds)) #none
#Status
#missing FFD / missing n_fl (still to be imputed from shoot_vol) / nodata / ok
alldata$status<-as.factor(ifelse(is.na(alldata$FFD)&alldata$data==1,"missFFD",ifelse(alldata$data==0,"nodata",
ifelse(is.na(alldata$cum_n_fl)&alldata$data==1,"missnfl","ok"))))
plot(alldata$status)
plot(subset(alldata,period=="old")$status)
plot(subset(alldata,period=="new")$status)
nrow(subset(alldata,status=="missFFD")) #134
nrow(subset(alldata,status=="missnfl")) #66
nrow(subset(alldata,status=="missnfl"&!is.na(shoot_vol))) #63 to impute cum_n_fl from shoot_vol
nrow(subset(alldata,data==1&shoot_vol==0)) #1 pl with shoot_vol=0, impute later if we need shoot volume?
#Imputation of cum_n_fl from shoot_vol
with(alldata,hist(shoot_vol))
with(alldata,hist(log(shoot_vol)))
with(alldata,hist(cum_n_fl))
with(alldata,hist(log(cum_n_fl)))
model_vol1<-lm(log(cum_n_fl)~log(shoot_vol),subset(alldata,data==1&shoot_vol>0&!is.na(cum_n_fl)))
summary(model_vol1) #R2=0.3427
plot(model_vol1)
summary(model_vol2)
NagelkerkeR2(model_vol2) #R20.5709834 --> better, use
plot(model_vol2)
ggplot(subset(alldata,data==1&shoot_vol>0),aes(x=shoot_vol,y=cum_n_fl))+geom_point()+geom_smooth(method="lm")
ggplot(subset(alldata,data==1&shoot_vol>0),aes(x=log(shoot_vol),y=log(cum_n_fl)))+geom_point()+geom_smooth(method="lm")
ggplot(subset(alldata,data==1&shoot_vol>0),aes(x=shoot_vol,y=cum_n_fl))+geom_point()+geom_smooth(method="glm.nb")
predict_fl<-as.data.frame(predict(model_vol2,newdata=subset(alldata,status=="missnfl"&!is.na(shoot_vol)),type="response"))
names(predict_fl)<-c("cum_n_fl_i")
alldata<-merge(alldata, predict_fl, by="row.names",all.x=T) #New colum with imputed cum_n_fl (cum_n_fl_i) for pls where status=="missnfl" that had shoot_vol
alldata$Row.names<-NULL
alldata$n_fl<-ifelse(is.na(alldata$cum_n_fl),alldata$cum_n_fl_i,alldata$cum_n_fl)
alldata$n_fl_imputed<-ifelse(alldata$cum_n_fl_action=="impute",1,0) #Says if n_fl was imputed (1) or not (0)
#Actualize status
alldata$status<-as.factor(ifelse(is.na(alldata$FFD)&alldata$data==1,"missFFD",ifelse(alldata$data==0,"nodata",
ifelse(is.na(alldata$n_fl)&alldata$data==1,"missnfl","ok"))))
plot(alldata$status)
nrow(subset(alldata,status=="missFFD")) #134
nrow(subset(alldata,status=="missnfl")) #3
#Remove unnecesary columns
alldata<-alldata[c(1:5,8,9,13:20,22:23)]
alldata$n_seeds<-alldata$total_n_seeds
alldata$n_intact_seeds<-alldata$total_n_intact_seeds
alldata$total_n_seeds<-NULL
alldata$total_n_intact_seeds<-NULL
alldata<-alldata[c("year","period","id","ruta","genet","data","status","FFD","FFD_imputed","n_fl","n_fl_imputed",
"shoot_vol","grazing","n_fr","n_ovules","n_seeds","n_intact_seeds")]
head(alldata)
subset(alldata,status=="missFFD"|status=="missnfl") #137
subset(subset(alldata,status=="missFFD"|status=="missnfl"),period=="new") #49
subset_old_missing<-subset(subset(alldata,status=="missFFD"|status=="missnfl"),period=="old") #88 (only missing FFD)
subset_old_missing[order(subset_old_missing$year,subset_old_missing$ruta,subset_old_missing$genet),] #Send to Johan for double-checking
alldata_ok<-subset(alldata,status=="ok")
plot(alldata_ok$year)
write.table(alldata,file="C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/alldata.csv",sep="\t",dec=".",col.names=T)
write.table(alldata_ok,file="C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/alldata_ok.csv",sep="\t",dec=".",col.names=T)
nrow(subset_old_missing)
library(tidyr)
library(plyr)
library(sjPlot)
library(ggplot2)
library(fmsb)
library(xtable)
library(gridExtra)
library(MASS)
options(xtable.floating = FALSE)
options(xtable.timestamp = "")
options(xtable.comment = FALSE)
data_imput<-read.table("C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/data_20062017_forimput.csv",
header=T,sep="\t",dec=",") #Read all data
bud_sizes<-read.table("C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/bud_sizes.csv",
header=T,sep="\t",dec=",") #Read data on bud sizes
head(data_imput)
str(data_imput)
data_imput$FFD_corr<-as.Date(as.character(data_imput$FFD_corr),format="%d/%m/%Y")
head(bud_sizes)
bud_sizes[sapply(bud_sizes, function(x) all(is.na(x)))] <- NULL #remove columns with all NAs
str(bud_sizes)
bud_sizes<-gather(bud_sizes, key=day, value=bud_size, X114:X148,factor_key=T) #Convert from wide to long
bud_sizes<-subset(bud_sizes,!bud_size=="") #remove rows with blank bud_size
bud_sizes$day<-as.integer(substring(as.character(bud_sizes$day),2))
bud_sizes$bud_size[bud_sizes$bud_size=="S"] <- 1
bud_sizes$bud_size[bud_sizes$bud_size=="M"] <- 2
bud_sizes$bud_size[bud_sizes$bud_size=="L"] <- 3
bud_sizes$bud_size[bud_sizes$bud_size=="XL"] <-4
bud_sizes$bud_size<-as.integer(bud_sizes$bud_size)
head(bud_sizes)
str(bud_sizes)
#subset to use for building a model of FFD against bud size and day
subset_model<-subset(bud_sizes,!FFD_action=="impute")
with(subset_model,hist(FFD_julian,breaks=50))
with(subset_model,hist(bud_size))
with(subset_model,hist(day))
with(subset_model,plot(as.factor(bud_size)~day))
with(subset_model,plot(FFD_julian~as.factor(bud_size)))
with(subset_model,plot(FFD_julian~day))
model_FFD<-lm(FFD_julian~bud_size*day,subset_model)
summary(model_FFD)
par(mfrow=c(2,2))
plot(model_FFD)
sjp.int(model_FFD, type = "eff",mdrt.values = "quart",swap.pred=T) #Plot of interaction effect
model_FFD06<-lm(FFD_julian~bud_size+day,subset(subset_model,year==2006))
model_FFD07<-lm(FFD_julian~bud_size+day,subset(subset_model,year==2007))
model_FFD08<-lm(FFD_julian~bud_size+day,subset(subset_model,year==2008))
model_FFD09<-lm(FFD_julian~bud_size+day,subset(subset_model,year==2009))
model_FFD10<-lm(FFD_julian~bud_size*day,subset(subset_model,year==2010))
model_FFD11<-lm(FFD_julian~bud_size*day,subset(subset_model,year==2011))
model_FFD12<-lm(FFD_julian~bud_size*day,subset(subset_model,year==2012))
model_FFD13<-lm(FFD_julian~bud_size*day,subset(subset_model,year==2013))
model_FFD14<-lm(FFD_julian~bud_size*day,subset(subset_model,year==2014))
model_FFD15<-lm(FFD_julian~bud_size+day,subset(subset_model,year==2015))
summary(model_FFD06)
summary(model_FFD07)
summary(model_FFD08)
summary(model_FFD09)
summary(model_FFD10)
summary(model_FFD11)
summary(model_FFD12)
summary(model_FFD13)
summary(model_FFD14)
summary(model_FFD15)
data06<-data.frame(observed=subset(subset_model,year==2006)$FFD_julian, predicted=predict(model_FFD06))
data07<-data.frame(observed=subset(subset_model,year==2007)$FFD_julian, predicted=predict(model_FFD07))
data08<-data.frame(observed=subset(subset_model,year==2008)$FFD_julian, predicted=predict(model_FFD08))
data09<-data.frame(observed=subset(subset_model,year==2009)$FFD_julian, predicted=predict(model_FFD09))
data10<-data.frame(observed=subset(subset_model,year==2010)$FFD_julian, predicted=predict(model_FFD10))
data11<-data.frame(observed=subset(subset_model,year==2011)$FFD_julian, predicted=predict(model_FFD11))
data12<-data.frame(observed=subset(subset_model,year==2012)$FFD_julian, predicted=predict(model_FFD12))
data13<-data.frame(observed=subset(subset_model,year==2013)$FFD_julian, predicted=predict(model_FFD13))
data14<-data.frame(observed=subset(subset_model,year==2014)$FFD_julian, predicted=predict(model_FFD14))
data15<-data.frame(observed=subset(subset_model,year==2015)$FFD_julian, predicted=predict(model_FFD15))
grid.arrange(
ggplot(data06) +geom_density(aes(x=observed),alpha=.3, fill="blue")+geom_density(aes(x=predicted),alpha=.3, fill="red")+ggtitle("2006"),
ggplot(data07) +geom_density(aes(x=observed),alpha=.3, fill="blue")+geom_density(aes(x=predicted),alpha=.3, fill="red")+ggtitle("2007"),
ggplot(data08) +geom_density(aes(x=observed),alpha=.3, fill="blue")+geom_density(aes(x=predicted),alpha=.3, fill="red")+ggtitle("2008"),
ggplot(data09) +geom_density(aes(x=observed),alpha=.3, fill="blue")+geom_density(aes(x=predicted),alpha=.3, fill="red")+ggtitle("2009"),
ggplot(data10) +geom_density(aes(x=observed),alpha=.3, fill="blue")+geom_density(aes(x=predicted),alpha=.3, fill="red")+ggtitle("2010"),
ggplot(data11) +geom_density(aes(x=observed),alpha=.3, fill="blue")+geom_density(aes(x=predicted),alpha=.3, fill="red")+ggtitle("2011"),
ggplot(data12) +geom_density(aes(x=observed),alpha=.3, fill="blue")+geom_density(aes(x=predicted),alpha=.3, fill="red")+ggtitle("2012"),
ggplot(data13) +geom_density(aes(x=observed),alpha=.3, fill="blue")+geom_density(aes(x=predicted),alpha=.3, fill="red")+ggtitle("2013"),
ggplot(data14) +geom_density(aes(x=observed),alpha=.3, fill="blue")+geom_density(aes(x=predicted),alpha=.3, fill="red")+ggtitle("2014"),
ggplot(data15) +geom_density(aes(x=observed),alpha=.3, fill="blue")+geom_density(aes(x=predicted),alpha=.3, fill="red")+ggtitle("2015"),
ncol=3)
#Use per-year models
#to predict FFD values where FFD_action=biased/imp_bdsize/impute
predict06<-as.data.frame(predict(model_FFD06,newdata=subset(subset(bud_sizes,year==2006),FFD_action=="impute")))
predict07<-as.data.frame(predict(model_FFD07,newdata=subset(subset(bud_sizes,year==2007),FFD_action=="impute")))
predict08<-as.data.frame(predict(model_FFD08,newdata=subset(subset(bud_sizes,year==2008),FFD_action=="impute")))
predict09<-as.data.frame(predict(model_FFD09,newdata=subset(subset(bud_sizes,year==2009),FFD_action=="impute")))
predict10<-as.data.frame(predict(model_FFD10,newdata=subset(subset(bud_sizes,year==2010),FFD_action=="impute")))
predict11<-as.data.frame(predict(model_FFD11,newdata=subset(subset(bud_sizes,year==2011),FFD_action=="impute")))
predict12<-as.data.frame(predict(model_FFD12,newdata=subset(subset(bud_sizes,year==2012),FFD_action=="impute")))
predict13<-as.data.frame(predict(model_FFD13,newdata=subset(subset(bud_sizes,year==2013),FFD_action=="impute")))
predict14<-as.data.frame(predict(model_FFD14,newdata=subset(subset(bud_sizes,year==2014),FFD_action=="impute")))
predict15<-as.data.frame(predict(model_FFD15,newdata=subset(subset(bud_sizes,year==2015),FFD_action=="impute")))
names(predict06)<-c("FFD_i")
names(predict07)<-c("FFD_i")
names(predict08)<-c("FFD_i")
names(predict09)<-c("FFD_i")
names(predict10)<-c("FFD_i")
names(predict11)<-c("FFD_i")
names(predict12)<-c("FFD_i")
names(predict13)<-c("FFD_i")
names(predict14)<-c("FFD_i")
names(predict15)<-c("FFD_i")
predictions<-rbind(predict06,predict07,predict08,predict09,predict10,predict11,predict12,predict13,predict14,predict15)
bud_sizes<-merge(bud_sizes, predictions, by="row.names",all.x=T) #New colum with imputed FFD (FFD_i) for pls where FFD_action=biased/imp_bdsize/impute
bud_sizes$Row.names<-NULL
bud_sizes<-unique(bud_sizes[c("year", "id","FFD_julian","FFD_action","FFD_i")])
bud_sizes$FFD_buds<-ifelse(is.na(bud_sizes$FFD_julian),bud_sizes$FFD_i,bud_sizes$FFD_julian)
bud_sizes$FFD_imputed<-ifelse(bud_sizes$FFD_action=="impute",1,0) #Says if FFD was imputed (1) or not (0)
head(bud_sizes)
str(bud_sizes)
#merge with data imput
data_imput<-merge(data_imput,bud_sizes[c(1:2,6,7)],by=c("year","id"),all.x=T,all.y=T)
data_imput$FFD_corr<-NULL
data_imput$FFD<-ifelse(is.na(data_imput$FFD_jul),data_imput$FFD_buds,data_imput$FFD_jul)
data_imput$FFD_jul<-NULL
data_imput$FFD_buds<-NULL
head(data_imput)
str(data_imput)
subset(data.frame(with(data_imput,table(year,id))),Freq>1) #No repeated ids!
nrow(subset(data_imput,FFD_action=="impute"&!is.na(FFD))) #56 cases imputed
nrow(subset(data_imput,FFD_action=="impute"&is.na(FFD))) #46 cases could not be imputed because no info on bud sizes
nrow(subset(data_imput,is.na(FFD)&data==1)) #46 cases where FFD is NA = cases that could not be imputed --> mark as missing data
nrow(subset(data_imput,data==1&is.na(shoot_vol))) #37 pls with no shoot_vol
nrow(subset(data_imput,data==1&is.na(cum_n_fl))) #24 pls with no cum_n_fl
nrow(subset(data_imput,data==1&is.na(cum_n_fl)&is.na(shoot_vol)))
#3 pls with no shoot_vol and no cum_n_fl --> mark as missing data
nrow(subset(data_imput,is.na(cum_n_fl)&data==1&!is.na(shoot_vol)))
#We can predict shoot_vol from cum_n_fl in 24-3=21 pls
head(data_imput) #Data 2006-2017
data_imput$id<-paste("new",data_imput$id,sep="_") #Add "new" to the ids
data_8796<-read.table("C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/data_19871996.csv",header=T,sep="\t",dec=",")
head(data_8796)
str(data_8796)
data_8796$id<-paste("old",data_8796$id,sep="_") #Add "old" to the ids
data_8796$FFD1<-NULL
data_8796$start<-NULL
data_8796$FFD_date<-NULL
data_imput$ruta<-NA
data_imput$genet<-NA
data_imput<-data_imput[c("year", "id", "ruta","genet","data","vernal","FFD_action","grazing","shoot_vol","shoot_vol_action",
"cum_n_fl","cum_n_fl_action","n_fr","n_ovules","total_n_seeds","total_n_intact_seeds","FFD_imputed","FFD")]
alldata<-rbind(data_8796,data_imput) #Join both "old" and "new" data
head(alldata)
str(alldata)
alldata$period<-with(alldata,ifelse(grepl("old", alldata$id), "old", "new"))
alldata$year<-as.factor(alldata$year)
alldata$id<-as.factor(alldata$id)
alldata$data<-as.factor(alldata$data)
alldata$FFD_imputed<-as.factor(alldata$FFD_imputed)
alldata$period<-as.factor(alldata$period)
hist(alldata) #Quickly see all distributions - looks OK!
subset(alldata,n_ovules>0&n_fr==0) #No pls with ovules but not fruits
subset(alldata,total_n_seeds>0&n_ovules==0) #No pls with seeds but not ovules
subset(alldata,total_n_seeds>0&n_fr==0) #No pls with seeds but not fruits
subset(alldata,total_n_intact_seeds>0&n_fr==0) #No pls with intact seeds but not fruits
ov_per_fr<-alldata$n_ovules/alldata$n_fr
hist(ov_per_fr)
mean(ov_per_fr[!is.na(ov_per_fr)]) #mean n_ovules per fr is 12.9 (should be around 13)
#Pls with data=0 and actually some data?
subset(alldata,data==0&!is.na(FFD)) #No
subset(alldata,data==0&!is.na(cum_n_fl)) #No
subset(alldata,data==0&!is.na(n_fr)) #No
subset(alldata,data==0&!is.na(n_ovules))  #No
subset(alldata,data==0&!is.na(total_n_seeds))  #No
subset(alldata,data==0&!is.na(total_n_intact_seeds)) #No
subset(alldata,data==0&!is.na(shoot_vol)) #Yes, but OK
subset(alldata,data==0&!is.na(grazing)) #No
#Pls with data=1 and FFD missing
nrow(subset(alldata,data==1&period=="new"&is.na(FFD))) #46 from new period (where data could not be imputed)-OK
nrow(subset(alldata,data==1&period=="old"&is.na(FFD))) #88 from old period
#See them per years
data.frame(table(subset(alldata,data==1&is.na(FFD))$year))
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1987) #0
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1988) #6 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1989) #30 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1990) #4 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1991) #1 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1992) #1 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1993) #3 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1994) #8 - with n_fl but no FFD
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1995) #35
subset(alldata,data==1&period=="old"&is.na(FFD)&year==1996) #0
#Pls with data=1 and cum_n_fl missing
nrow(subset(alldata,data==1&period=="new"&is.na(cum_n_fl))) #24 from new period-OK, to be imputed from shoot_vol
nrow(subset(alldata,data==1&period=="old"&is.na(cum_n_fl))) #51 from old period-All have shoot_vol, could also impute fl from there
subset(alldata,cum_n_fl==0) #No pls with 0 flowers
#Pls with data=1 and grazing missing
subset(alldata,data==1&is.na(grazing)) #No
subset(alldata,data==1&is.na(n_fr)) #0
subset(alldata,data==1&is.na(n_ovules)) #159, 1987-88-89-90-91-92-93-94
#Calculate mean n ovules per fr for each of these years --> USE FOR CALCULATING N_OVULES
n_ovules_per_fr<-with(subset(alldata,year==1987|year==1988|year==1989|year==1990|year==1991|year==1992|year==1993|year==1994|year==1995),aggregate(n_ovules/n_fr~year, FUN=mean))
alldata$n_ovules<-ifelse(is.na(alldata$n_ovules)&alldata$year=="1987",n_ovules_per_fr$`n_ovules/n_fr`[1]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1988",n_ovules_per_fr$`n_ovules/n_fr`[2]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1989",n_ovules_per_fr$`n_ovules/n_fr`[3]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1990",n_ovules_per_fr$`n_ovules/n_fr`[4]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1991",n_ovules_per_fr$`n_ovules/n_fr`[5]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1992",n_ovules_per_fr$`n_ovules/n_fr`[6]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1993",n_ovules_per_fr$`n_ovules/n_fr`[7]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1994",n_ovules_per_fr$`n_ovules/n_fr`[8]*alldata$n_fr,
ifelse(is.na(alldata$n_ovules)&alldata$year=="1995",n_ovules_per_fr$`n_ovules/n_fr`[9]*alldata$n_fr,
alldata$n_ovules)))))))))
with(subset(alldata,year=="1987"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1988"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1989"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1990"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1991"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1992"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1993"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1994"),hist(n_ovules,breaks=200))
with(subset(alldata,year=="1995"),hist(n_ovules,breaks=200))
mean(ov_per_fr[!is.na(ov_per_fr)]) #Similar
subset(alldata,data==1&is.na(total_n_seeds)) #66
subset(alldata,data==1&is.na(total_n_intact_seeds)) #66
#Calculate mean total_n_seeds per fr for each of these years --> USE FOR CALCULATING total_n_seeds
total_n_seeds_per_fr<-with(subset(alldata,year==1990|year==1991|year==1992|year==1993|year==1994|year==1995),
aggregate(total_n_seeds/n_fr~year, FUN=mean))
alldata$total_n_seeds<-ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1990",total_n_seeds_per_fr$`total_n_seeds/n_fr`[1]*alldata$n_fr,
ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1991",total_n_seeds_per_fr$`total_n_seeds/n_fr`[2]*alldata$n_fr,
ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1992",total_n_seeds_per_fr$`total_n_seeds/n_fr`[3]*alldata$n_fr,
ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1993",total_n_seeds_per_fr$`total_n_seeds/n_fr`[4]*alldata$n_fr,
ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1994",total_n_seeds_per_fr$`total_n_seeds/n_fr`[5]*alldata$n_fr,
ifelse(is.na(alldata$total_n_seeds)&alldata$year=="1995",total_n_seeds_per_fr$`total_n_seeds/n_fr`[6]*alldata$n_fr,
alldata$total_n_seeds))))))
hist(alldata$total_n_seeds)
#Calculate mean total_n_intact_seeds per fr for each of these years --> USE FOR CALCULATING total_n_intact_seeds
total_n_intact_seeds_per_fr<-with(subset(alldata,year==1990|year==1991|year==1992|year==1993|year==1994|year==1995),
aggregate(total_n_intact_seeds/n_fr~year, FUN=mean))
alldata$total_n_intact_seeds<-ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1990",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[1]*alldata$n_fr,
ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1991",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[2]*alldata$n_fr,
ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1992",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[3]*alldata$n_fr,
ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1993",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[4]*alldata$n_fr,
ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1994",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[5]*alldata$n_fr,
ifelse(is.na(alldata$total_n_intact_seeds)&alldata$year=="1995",total_n_intact_seeds_per_fr$`total_n_intact_seeds/n_fr`[6]*alldata$n_fr,
alldata$total_n_intact_seeds))))))
hist(alldata$total_n_intact_seeds)
subset(alldata,total_n_seeds>n_ovules) #none
subset(alldata,n_fr>0&total_n_seeds==0) #none
subset(alldata,n_fr>0&is.na(total_n_seeds)) #none
subset(alldata,total_n_intact_seeds>total_n_seeds) #none
subset(alldata,total_n_seeds>0&is.na(total_n_intact_seeds)) #none
subset(alldata,total_n_intact_seeds>0&is.na(total_n_seeds)) #none
#Status
#missing FFD / missing n_fl (still to be imputed from shoot_vol) / nodata / ok
alldata$status<-as.factor(ifelse(is.na(alldata$FFD)&alldata$data==1,"missFFD",ifelse(alldata$data==0,"nodata",
ifelse(is.na(alldata$cum_n_fl)&alldata$data==1,"missnfl","ok"))))
plot(alldata$status)
plot(subset(alldata,period=="old")$status)
plot(subset(alldata,period=="new")$status)
nrow(subset(alldata,status=="missFFD")) #134
nrow(subset(alldata,status=="missnfl")) #66
nrow(subset(alldata,status=="missnfl"&!is.na(shoot_vol))) #63 to impute cum_n_fl from shoot_vol
nrow(subset(alldata,data==1&shoot_vol==0)) #1 pl with shoot_vol=0, impute later if we need shoot volume?
with(alldata,hist(shoot_vol))
with(alldata,hist(log(shoot_vol)))
with(alldata,hist(cum_n_fl))
with(alldata,hist(log(cum_n_fl)))
model_vol1<-lm(log(cum_n_fl)~log(shoot_vol),subset(alldata,data==1&shoot_vol>0&!is.na(cum_n_fl)))
summary(model_vol1) #R2=0.3427
plot(model_vol1)
with(subset(alldata,data==1&shoot_vol>0),plot(log(cum_n_fl)~log(shoot_vol)))
abline(model_vol1)
model_vol2<-glm.nb(cum_n_fl~shoot_vol,subset(alldata,data==1&shoot_vol>0&!is.na(cum_n_fl)))
summary(model_vol2)
NagelkerkeR2(model_vol2) #R20.5709834 --> better, use
plot(model_vol2)
ggplot(subset(alldata,data==1&shoot_vol>0),aes(x=shoot_vol,y=cum_n_fl))+geom_point()+geom_smooth(method="lm")
ggplot(subset(alldata,data==1&shoot_vol>0),aes(x=log(shoot_vol),y=log(cum_n_fl)))+geom_point()+geom_smooth(method="lm")
ggplot(subset(alldata,data==1&shoot_vol>0),aes(x=shoot_vol,y=cum_n_fl))+geom_point()+geom_smooth(method="glm.nb")
predict_fl<-as.data.frame(predict(model_vol2,newdata=subset(alldata,status=="missnfl"&!is.na(shoot_vol)),type="response"))
names(predict_fl)<-c("cum_n_fl_i")
alldata<-merge(alldata, predict_fl, by="row.names",all.x=T) #New colum with imputed cum_n_fl (cum_n_fl_i) for pls where status=="missnfl" that had shoot_vol
alldata$Row.names<-NULL
alldata$n_fl<-ifelse(is.na(alldata$cum_n_fl),alldata$cum_n_fl_i,alldata$cum_n_fl)
alldata$n_fl_imputed<-ifelse(alldata$cum_n_fl_action=="impute",1,0) #Says if n_fl was imputed (1) or not (0)
#Actualize status
alldata$status<-as.factor(ifelse(is.na(alldata$FFD)&alldata$data==1,"missFFD",ifelse(alldata$data==0,"nodata",
ifelse(is.na(alldata$n_fl)&alldata$data==1,"missnfl","ok"))))
plot(alldata$status)
nrow(subset(alldata,status=="missFFD")) #134
nrow(subset(alldata,status=="missnfl")) #3
#Remove unnecesary columns
alldata<-alldata[c(1:5,8,9,13:20,22:23)]
alldata$n_seeds<-alldata$total_n_seeds
alldata$n_intact_seeds<-alldata$total_n_intact_seeds
alldata$total_n_seeds<-NULL
alldata$total_n_intact_seeds<-NULL
alldata<-alldata[c("year","period","id","ruta","genet","data","status","FFD","FFD_imputed","n_fl","n_fl_imputed",
"shoot_vol","grazing","n_fr","n_ovules","n_seeds","n_intact_seeds")]
head(alldata)
subset(alldata,status=="missFFD"|status=="missnfl") #137
nrow()
nrow(subset(alldata,status=="missFFD"|status=="missnfl"))
subset(subset(alldata,status=="missFFD"|status=="missnfl"),period=="new") #49
nrow(subset(subset(alldata,status=="missFFD"|status=="missnfl"),period=="new"))
nrow(subset(subset(alldata,status=="missFFD"|status=="missnfl"),period=="old"))
subset_old_missing<-subset(subset(alldata,status=="missFFD"|status=="missnfl"),period=="old") #88 (only missing FFD)
subset_old_missing[order(subset_old_missing$year,subset_old_missing$ruta,subset_old_missing$genet),] #Send to Johan for double-checking
alldata_ok<-subset(alldata,status=="ok")
plot(alldata_ok$year)
nrow(subset_old_missing)
write.table(alldata,file="C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/alldata.csv",sep="\t",dec=".",col.names=T)
write.table(alldata_ok,file="C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/alldata_ok.csv",sep="\t",dec=".",col.names=T)
library(lattice)
library(ggplot2)
library(gridExtra)
library(sciplot)
alldata<-read.csv("C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/alldata.csv",
header=T,sep="\t",dec=".") #Read data
alldata$period<-with(alldata,ifelse(grepl("old", alldata$id), "old", "new"))
alldata$year<-as.factor(alldata$year)
alldata$id<-as.factor(alldata$id)
alldata$data<-as.factor(alldata$data)
alldata$FFD_imputed<-as.factor(alldata$FFD_imputed)
alldata$period<-as.factor(alldata$period)
ggplot(alldata,aes(x=status,fill=period))+geom_bar(position=position_dodge())
par(mfrow=c(2,4))
boxplot(alldata$grazing,main="grazing")
boxplot(alldata$shoot_vol,main="shoot_volume")
boxplot(alldata$n_fl,main="n_fl")
boxplot(alldata$n_fr,main="n_fr")
boxplot(alldata$n_ovules,main="n_ovules")
boxplot(alldata$n_seeds,main="n_seeds")
boxplot(alldata$n_intact_seeds,main="n_intact_seeds")
boxplot(alldata$FFD,main="FFD")
Z <- cbind(alldata$grazing, alldata$shoot_vol,
alldata$n_fl,alldata$n_fr,
alldata$n_ovules,alldata$n_seeds,
alldata$n_intact_seeds,alldata$FFD)
colnames(Z) <- c("grazing","shoot_vol","n_fl","n_fr","n_ovules",
"n_seeds","n_intact_seeds","FFD")
dotplot(as.matrix(Z), groups = FALSE,
strip = strip.custom(bg = 'white',
par.strip.text = list(cex = 0.8)),
scales = list(x = list(relation = "free"),
y = list(relation = "free"),
draw = F),
col = 1, cex  = 0.5, pch = 16,
xlab = "Value of the variable",
ylab = "Order of the data from text file")
grid.arrange(ggplot(alldata, aes(x=year, y=FFD)) + geom_boxplot(),
ggplot(alldata, aes(x=period, y=FFD)) + geom_boxplot(),ncol=2,widths=c(12,3))
par(mfrow=c(1,2))
lineplot.CI(alldata$year,alldata$FFD,xlab="year",ylab="FFD")
lineplot.CI(alldata$period,alldata$FFD,xlab="period",ylab="FFD")
grid.arrange(ggplot(alldata, aes(x=year, y=n_intact_seeds)) + geom_boxplot(),
ggplot(alldata, aes(x=period, y=n_intact_seeds)) + geom_boxplot(),ncol=2,widths=c(12,3))
par(mfrow=c(1,2))
lineplot.CI(alldata$year,alldata$n_intact_seeds,xlab="year",ylab="n_intact_seeds")
lineplot.CI(alldata$period,alldata$n_intact_seeds,xlab="period",ylab="n_intact_seeds")
grid.arrange(ggplot(alldata,aes(x=FFD))+geom_density(alpha=.2, fill="#FF6666"),
ggplot(alldata,aes(x=grazing))+geom_density(alpha=.2, fill="#FF6666"),
ggplot(alldata,aes(x=shoot_vol))+geom_density(alpha=.2, fill="#FF6666"),
ggplot(alldata,aes(x=n_fl))+geom_density(alpha=.2, fill="#FF6666"),
ggplot(alldata,aes(x=n_fr))+geom_density(alpha=.2, fill="#FF6666"),
ggplot(alldata,aes(x=n_ovules))+geom_density(alpha=.2, fill="#FF6666"),
ggplot(alldata,aes(x=n_seeds))+geom_density(alpha=.2, fill="#FF6666"),
ggplot(alldata,aes(x=n_intact_seeds))+geom_density(alpha=.2, fill="#FF6666"),ncol=2)
ggplot(alldata,aes(x=FFD))+geom_density(alpha=.2, fill="#FF6666")+facet_wrap(~year, ncol=4)
ggplot(alldata,aes(x=n_intact_seeds))+geom_density(alpha=.2, fill="#FF6666")+facet_wrap(~year, ncol=4)
par(mfrow=c(2,2))
plot(table(round(alldata$n_fr)),type = "h",
xlab = "Observed values", ylab = "Frequency",main="Number of fruits")
plot(table(round(alldata$n_ovules)),type = "h",
xlab = "Observed values", ylab = "Frequency",main="Number of ovules")
plot(table(round(alldata$n_seeds)),type = "h",
xlab = "Observed values", ylab = "Frequency",main="Number of total seeds")
plot(table(round(alldata$n_intact_seeds)),type = "h",
xlab = "Observed values", ylab = "Frequency",main="Number of intact seeds")
with(alldata,cor(FFD,n_fl,use="complete.obs"))
grid.arrange(ggplot(alldata,aes(x=FFD,y=n_fr))+geom_point()+geom_smooth(method=lm),
ggplot(alldata,aes(x=FFD,y=n_seeds))+geom_point()+geom_smooth(method=lm),
ggplot(alldata,aes(x=FFD,y=n_intact_seeds))+geom_point()+geom_smooth(method=lm),
ggplot(alldata,aes(x=n_fl,y=n_fr))+geom_point()+geom_smooth(method=lm),
ggplot(alldata,aes(x=n_fl,y=n_seeds))+geom_point()+geom_smooth(method=lm),
ggplot(alldata,aes(x=n_fl,y=n_intact_seeds))+geom_point()+geom_smooth(method=lm),ncol=3)
ggplot(alldata,aes(x=FFD,y=n_intact_seeds))+geom_point()+geom_smooth(method=lm)+facet_wrap(~year,ncol=4,scales="free_y")
ggplot(alldata,aes(x=FFD,y=grazing))+geom_point()+geom_smooth(method=glm,method.args=c(family="binomial"))
subset(alldata,n_intact_seeds<0)
