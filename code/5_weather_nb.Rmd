---
title: "Lathyrus - Weather"
geometry: margin=2cm
fontsize: 10pt
output:
  pdf_document: 
    toc: yes
---
\newpage
```{r Load packages and data, include=FALSE}
library(ggplot2)
library(ggridges)
library(tidyverse)
library(ggthemes)
library(sciplot)
library(dplyr)
library(tidyr)
library(gridExtra)
library(lubridate)
library(knitr)
library(reshape)
library(pander)
library(fmsb)
library(moments)
library(papeR)

panderOptions('table.continues', '')
load(file = "C:/Users/User/Dropbox/SU/Projects/lathyrus/alldata.RData")
temperature<-read.table("C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/temperature.csv",header=T,sep="\t",dec=".") 
precipitation<-read.table("C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/precipitation.csv",header=T,sep="\t",dec=",") 
temperature<-subset(temperature,year<1997|year>2005)
precipitation<-subset(precipitation,year<1997|year>2005)
temperature$date<-as.Date(temperature$date)
precipitation$date<-as.Date(precipitation$date)
```

# Temperature and precipitation data manipulation
Temperature (daily mean, minimum and maximum) from two stations: Oxelösund and Södertalje  
Precipitation from one station: Åda
```{r Temperature and precipitation data, echo=FALSE}
kable(head(temperature[c(1:5,7:12)]))
kable(head(precipitation[c(1:5,7:8)]))
```

## Distributions

```{r Distributions, echo=FALSE, fig.height=4, fig.width=24}
par(mfrow=c(1,4))
hist(temperature$mean,main=NULL,cex.axis=2,cex.lab=2)
hist(temperature$min,main=NULL,cex.axis=2,cex.lab=2)
hist(temperature$max,main=NULL,cex.axis=2,cex.lab=2)
hist(precipitation$precipitation,breaks=100,main=NULL,cex.axis=2,cex.lab=2)
```

## Boxplots per month

```{r Boxplots per month, echo=FALSE, fig.height=4, fig.width=24}
par(mfrow=c(1,4))
with(temperature,plot(mean~as.factor(month),cex.axis=2,cex.lab=2))
with(temperature,plot(min~as.factor(month),cex.axis=2,cex.lab=2))
with(temperature,plot(max~as.factor(month),cex.axis=2,cex.lab=2))
with(precipitation,plot(precipitation~as.factor(month),cex.axis=2,cex.lab=2))
```

\newpage
## Comparisons of mean temperatures for each year for both stations

```{r Mean temperatures for each year for both stations, warning=FALSE, include=FALSE}
data_summary <- function(data, varname, groupnames){
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-plyr::ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}
temp_sum <- data_summary(temperature, varname="mean", groupnames=c("year", "month","station"))
```

```{r Graph mean temperatures for each year for both stations, echo=FALSE, fig.height=12, fig.width=18}
ggplot(temp_sum,aes(x=month,y=mean,colour=station))+facet_wrap(~year,ncol=6)+geom_point()+
geom_line()+  geom_errorbar(aes(ymin=mean-sd,ymax=mean+sd),width=.2,position=position_dodge(0.05))+ theme(legend.position = "bottom")
```

## Average mean, min and max temperature of the two stations for further use + join with precipitation data
```{r Temperature: average mean, min and max for the two stations, include=FALSE}
temperature_av<-merge(
  merge(
  aggregate(mean ~ date+year+month+day+date_ok, data=temperature, FUN=mean),
  aggregate(min ~ date+year+month+day+date_ok, data=temperature, FUN=mean),
  all.x=T,all.y=T),
  aggregate(max ~ date+year+month+day+date_ok, data=temperature, FUN=mean),
  all.x=T,all.y=T)
```

```{r Merge temperature and precipitation data, echo=FALSE}
weather<-merge(temperature_av,precipitation[2:7],all.x=T,all.y=T)
kable(head(weather))
```
```{r Missing precipitation values, echo=TRUE}
nrow(subset(weather,is.na(precipitation))) #154 dates with missing precipitation
unique(subset(weather,is.na(precipitation))[2:3]) #See which years/months
#February 1988, June 1991, February 1992, October 1992 all missing
#Substitute with mean of all years for each specific date
weather$precipitation[is.na(weather$precipitation)&weather$year==1988&weather$month==2]<-
  with(subset(aggregate(precipitation ~ year+month+day, data= weather, FUN=sum),month==2),
  aggregate(precipitation~day,FUN=mean)$precipitation) 
weather$precipitation[is.na(weather$precipitation)&weather$year==1991&weather$month==6]<-
  with(subset(aggregate(precipitation ~ year+month+day, data= weather, FUN=sum),month==6),
  aggregate(precipitation~day,FUN=mean)$precipitation) 
weather$precipitation[is.na(weather$precipitation)&weather$year==1992&weather$month==2]<-
  with(subset(aggregate(precipitation ~ year+month+day, data= weather, FUN=sum),month==2),
  aggregate(precipitation~day,FUN=mean)$precipitation) 
weather$precipitation[is.na(weather$precipitation)&weather$year==1992&weather$month==10]<-
  with(subset(aggregate(precipitation ~ year+month+day, data= weather, FUN=sum),month==10),
  aggregate(precipitation~day,FUN=mean)$precipitation) 
#October-November 2017 leave as NAs, will be available later
```

## Calculation of GDD and GDH

Bases considered: 3/5/7/10 ºC

GDD:  
![GDD](C:/Users/User/Dropbox/SU/Projects/lathyrus/code/GDD.png)  

GDH:  
![GDH](C:/Users/User/Dropbox/SU/Projects/lathyrus/code/GDH.png)  
```{r Calculation of GDD and GDH}
weather$GDD3<-ifelse(with(weather,((max+min)/2)-3)<0,0,with(weather,((max+min)/2)-3))
weather$GDD5<-ifelse(with(weather,((max+min)/2)-5)<0,0,with(weather,((max+min)/2)-5))
weather$GDD7<-ifelse(with(weather,((max+min)/2)-7)<0,0,with(weather,((max+min)/2)-7))
weather$GDD10<-ifelse(with(weather,((max+min)/2)-10)<0,0,with(weather,((max+min)/2)-10))
weather$GDH3<-ifelse(with(weather,max<=3),0,
                     ifelse(with(weather,max>3&min>3),with(weather,24*(min-3)+12*(max-min)),
                            with(weather,12*(max-3)^2/(max-min))))
weather$GDH5<-ifelse(with(weather,max<=5),0,
                     ifelse(with(weather,max>5&min>5),with(weather,24*(min-5)+12*(max-min)),
                            with(weather,12*(max-5)^2/(max-min))))
weather$GDH7<-ifelse(with(weather,max<=7),0,
                     ifelse(with(weather,max>7&min>7),with(weather,24*(min-7)+12*(max-min)),
                            with(weather,12*(max-7)^2/(max-min))))
weather$GDH10<-ifelse(with(weather,max<=10),0,
                     ifelse(with(weather,max>10&min>10),with(weather,24*(min-10)+12*(max-min)),
                            with(weather,12*(max-10)^2/(max-min))))
pander(head(weather), split.table = 100, style = 'rmarkdown')
```

## Definition of 3 periods with respect to vernal equinox
a) Before vernal equinox (March 20-21 depending on the year)  
b) From vernal equinox to 60 days after  
c) 61+ days after vernal equinox (May 20-21 depending on the year)

```{r Define periods }
weather<-merge(weather,unique(alldata[c(1,6)])) #Add column with date of vernal equinox
weather$vernal_time<-as.POSIXct(weather$vernal,format="%d/%m/%y %H:%M")
weather$vernal<-as.Date(substring(weather$vernal,1,10),format="%Y-%m-%d")
weather$period<-with(weather,ifelse(date<vernal,"a",
                                    ifelse(date>=vernal&date<=vernal+60,"b","c")))

```

## Calculate julian date as day with respect to vernal equinox

```{r Calculate day with respect to vernal equinox}
weather$date_julian<-as.numeric(with(weather,as.POSIXct(date)-vernal_time)/60/24)
```

## Calculations weather by month
Calculate monthly means of temperature and montly sums of precipitation, GDD and GDH
```{r Montly data, warning=FALSE,message=FALSE}
mean_weather1<-plyr::join_all(list(
    aggregate(mean ~ year+month, data=weather, FUN=mean), #Monthly means of mean daily temperature
    aggregate(min ~ year+month, data=weather, FUN=mean), #Monthly means of min daily temperature
    aggregate(max ~ year+month, data=weather, FUN=mean), #Monthly means of max daily temperature
    aggregate(precipitation ~ year+month, data= weather, FUN=sum),#Monthly sums of precipitation
    aggregate(GDD3 ~ year+month,data= weather, FUN=sum),          #Monthly sums of GDD3
    aggregate(GDD5 ~ year+month,data= weather, FUN=sum),          #Monthly sums of GDD5
    aggregate(GDD7 ~ year+month,data= weather, FUN=sum),          #Monthly sums of GDD7
    aggregate(GDD10 ~ year+month,data= weather, FUN=sum),         #Monthly sums of GDD10
    aggregate(GDH3 ~ year+month,data= weather, FUN=sum),          #Monthly sums of GDH3
    aggregate(GDH5 ~ year+month,data= weather, FUN=sum),          #Monthly sums of GDH5
    aggregate(GDH7 ~ year+month,data= weather, FUN=sum),          #Monthly sums of GDH7
    aggregate(GDH10 ~ year+month,data= weather, FUN=sum)),        #Monthly sums of GDH10       
    by = NULL, type = "left", match = "all")
mean_weather2<-gather(mean_weather1, variable, value,mean,min,max,precipitation,
               GDD3,GDD5,GDD7,GDD10,GDH3,GDH5,GDH7,GDH10) %>%
               unite(var, variable, month) %>% 
               spread(var, value) #Convert to wide format with monthly variables
pander(head(mean_weather1), split.table = 100, style = 'rmarkdown')
```

## Calculations weather by period
Calculate temperature, precipitation and GDD/GDH for different periods considered to be important:  
- April-June  
- April-May  
- January-June  
- January-March  
- March-April

```{r Calculate temp, prec, GDD for different periods}
#Precipitation
mean_weather2$prec456<-with(mean_weather2,precipitation_4+precipitation_5+precipitation_6)
mean_weather2$prec45<-with(mean_weather2,precipitation_4+precipitation_5)
mean_weather2$prec123456<-with(mean_weather2,precipitation_1+precipitation_2+precipitation_3+
                          precipitation_4+precipitation_5+precipitation_6)
mean_weather2$prec123<-with(mean_weather2,precipitation_1+precipitation_2+precipitation_3)
mean_weather2$prec34<-with(mean_weather2,precipitation_3+precipitation_4)

#Mean temperature
mean_weather2$mean456<-with(mean_weather2,mean_4+mean_5+mean_6)
mean_weather2$mean45<-with(mean_weather2,mean_4+mean_5)
mean_weather2$mean123456<-with(mean_weather2,mean_1+mean_2+mean_3+mean_4+mean_5+mean_6)
mean_weather2$mean123<-with(mean_weather2,mean_1+mean_2+mean_3)
mean_weather2$mean34<-with(mean_weather2,mean_3+mean_4)

#Max temperature
mean_weather2$max456<-with(mean_weather2,max_4+max_5+max_6)
mean_weather2$max45<-with(mean_weather2,max_4+max_5)
mean_weather2$max123456<-with(mean_weather2,max_1+max_2+max_3+max_4+max_5+max_6)
mean_weather2$max123<-with(mean_weather2,max_1+max_2+max_3)
mean_weather2$max34<-with(mean_weather2,max_3+max_4)

#Min temperature
mean_weather2$min456<-with(mean_weather2,min_4+min_5+min_6)
mean_weather2$min45<-with(mean_weather2,min_4+min_5)
mean_weather2$min123456<-with(mean_weather2,min_1+min_2+min_3+min_4+min_5+min_6)
mean_weather2$min123<-with(mean_weather2,min_1+min_2+min_3)
mean_weather2$min34<-with(mean_weather2,min_3+min_4)

#GDD3
mean_weather2$GDD3_456<-with(mean_weather2,GDD3_4+GDD3_5+GDD3_6)
mean_weather2$GDD3_45<-with(mean_weather2,GDD3_4+GDD3_5)
mean_weather2$GDD3_123456<-with(mean_weather2,GDD3_1+GDD3_2+GDD3_3+GDD3_4+GDD3_5+GDD3_6)
mean_weather2$GDD3_123<-with(mean_weather2,GDD3_1+GDD3_2+GDD3_3)
mean_weather2$GDD3_34<-with(mean_weather2,GDD3_3+GDD3_4)

#GDD5
mean_weather2$GDD5_456<-with(mean_weather2,GDD5_4+GDD5_5+GDD5_6)
mean_weather2$GDD5_45<-with(mean_weather2,GDD5_4+GDD5_5)
mean_weather2$GDD5_123456<-with(mean_weather2,GDD5_1+GDD5_2+GDD5_3+GDD5_4+GDD5_5+GDD5_6)
mean_weather2$GDD5_123<-with(mean_weather2,GDD5_1+GDD5_2+GDD5_3)
mean_weather2$GDD5_34<-with(mean_weather2,GDD5_3+GDD5_4)

#GDD7
mean_weather2$GDD7_456<-with(mean_weather2,GDD7_4+GDD7_5+GDD7_6)
mean_weather2$GDD7_45<-with(mean_weather2,GDD7_4+GDD7_5)
mean_weather2$GDD7_123456<-with(mean_weather2,GDD7_1+GDD7_2+GDD7_3+GDD7_4+GDD7_5+GDD7_6)
mean_weather2$GDD7_123<-with(mean_weather2,GDD7_1+GDD7_2+GDD7_3)
mean_weather2$GDD7_34<-with(mean_weather2,GDD7_3+GDD7_4)

#GDD10
mean_weather2$GDD10_456<-with(mean_weather2,GDD10_4+GDD10_5+GDD10_6)
mean_weather2$GDD10_45<-with(mean_weather2,GDD10_4+GDD10_5)
mean_weather2$GDD10_123456<-with(mean_weather2,GDD10_1+GDD10_2+GDD10_3+GDD10_4+GDD10_5+GDD10_6)
mean_weather2$GDD10_123<-with(mean_weather2,GDD10_1+GDD10_2+GDD10_3)
mean_weather2$GDD10_34<-with(mean_weather2,GDD10_3+GDD10_4)

#GDH3
mean_weather2$GDH3_456<-with(mean_weather2,GDH3_4+GDH3_5+GDH3_6)
mean_weather2$GDH3_45<-with(mean_weather2,GDH3_4+GDH3_5)
mean_weather2$GDH3_123456<-with(mean_weather2,GDH3_1+GDH3_2+GDH3_3+GDH3_4+GDH3_5+GDH3_6)
mean_weather2$GDH3_123<-with(mean_weather2,GDH3_1+GDH3_2+GDH3_3)
mean_weather2$GDH3_34<-with(mean_weather2,GDH3_3+GDH3_4)

#GDH5
mean_weather2$GDH5_456<-with(mean_weather2,GDH5_4+GDH5_5+GDH5_6)
mean_weather2$GDH5_45<-with(mean_weather2,GDH5_4+GDH5_5)
mean_weather2$GDH5_123456<-with(mean_weather2,GDH5_1+GDH5_2+GDH5_3+GDH5_4+GDH5_5+GDH5_6)
mean_weather2$GDH5_123<-with(mean_weather2,GDH5_1+GDH5_2+GDH5_3)
mean_weather2$GDH5_34<-with(mean_weather2,GDH5_3+GDH5_4)

#GDH7
mean_weather2$GDH7_456<-with(mean_weather2,GDH7_4+GDH7_5+GDH7_6)
mean_weather2$GDH7_45<-with(mean_weather2,GDH7_4+GDH7_5)
mean_weather2$GDH7_123456<-with(mean_weather2,GDH7_1+GDH7_2+GDH7_3+GDH7_4+GDH7_5+GDH7_6)
mean_weather2$GDH7_123<-with(mean_weather2,GDH7_1+GDH7_2+GDH7_3)
mean_weather2$GDH7_34<-with(mean_weather2,GDH7_3+GDH7_4)

#GDH10
mean_weather2$GDH10_456<-with(mean_weather2,GDH10_4+GDH10_5+GDH10_6)
mean_weather2$GDH10_45<-with(mean_weather2,GDH10_4+GDH10_5)
mean_weather2$GDH10_123456<-with(mean_weather2,GDH10_1+GDH10_2+GDH10_3+GDH10_4+GDH10_5+GDH10_6)
mean_weather2$GDH10_123<-with(mean_weather2,GDH10_1+GDH10_2+GDH10_3)
mean_weather2$GDH10_34<-with(mean_weather2,GDH10_3+GDH10_4)
```

## Calculations weather for period "b"
Calculate temperature, precipitation and GDD/GDH for period "b" (from vernal equinox to 60 days after) and merge with previous data

```{r Calculate temperature, precipitation and GDD/GDH for period "b" and merge with previous data,message=FALSE}
mean_weather1_b<-plyr::join_all(list(
    aggregate(mean ~ year, data=subset(weather,period=="b"), FUN=mean), #Mean of mean daily temperature
    aggregate(min ~ year, data=subset(weather,period=="b"), FUN=mean), #Mean of min daily temperature
    aggregate(max ~ year, data=subset(weather,period=="b"), FUN=mean), #Mean of max daily temperature
    aggregate(precipitation ~ year, data= subset(weather,period=="b"), FUN=sum),#Sum of precipitation
    aggregate(GDD3 ~ year,data= subset(weather,period=="b"), FUN=sum),          #Sum of GDD3
    aggregate(GDD5 ~ year,data= subset(weather,period=="b"), FUN=sum),          #Sum of GDD5
    aggregate(GDD7 ~ year,data= subset(weather,period=="b"), FUN=sum),          #Sum of GDD7
    aggregate(GDD10 ~ year,data= subset(weather,period=="b"), FUN=sum),         #Sum of GDD10
    aggregate(GDH3 ~ year,data= subset(weather,period=="b"), FUN=sum),          #Sum of GDH3
    aggregate(GDH5 ~ year,data= subset(weather,period=="b"), FUN=sum),          #Sum of GDH5
    aggregate(GDH7 ~ year,data= subset(weather,period=="b"), FUN=sum),          #Sum of GDH7
    aggregate(GDH10 ~ year,data= subset(weather,period=="b"), FUN=sum)),        #Sum of GDH10       
    by = NULL, type = "left", match = "all")

mean_weather2_b<-gather(mean_weather1_b, variable, value,mean,min,max,precipitation,
               GDD3,GDD5,GDD7,GDD10,GDH3,GDH5,GDH7,GDH10) %>%
               unite(var, variable) %>% 
               spread(var, value) #Convert to wide format with variables for period "b"
colnames(mean_weather2_b)[2:13]<-paste(colnames(mean_weather2_b)[2:13],"b", sep = "_")
```

# Calculations FFD stats
Calculate mean, variance, duration, skewness and kurtosis of FFD and merge with previous data

```{r Calculate mean, variance, duration, skewness and kurtosis of FFD and merge with previous data}
mean_weather3<-merge(merge(mean_weather2,mean_weather2_b),
               as.data.frame(alldata %>% filter(!is.na(alldata$FFD)) %>% 
                                         dplyr::select(year,FFD)  %>%
                                         dplyr::group_by(year) %>% 
                                         dplyr::summarise(FFD_mean=mean(FFD),FFD_var=var(FFD),
                                         FFD_dur=range(FFD)[2]-range(FFD)[1],
                                         FFD_skew=skewness(FFD),FFD_kurt=kurtosis(FFD))
                                         )) 
names(mean_weather3)
```

# Models of FFD against weather variables

## With mean of FFD

```{r Models FFD_mean against temperature, precipitation and GDD/GDH,warning=FALSE,message=FALSE}
models<-lapply(names(mean_weather3)[c(7:9,19:21,31:33,43:45,
        55:57,67:69,79:81,91:93,103:105,115:117,127:129,139:141,146:217)], 
         function(x) {lm(substitute(FFD_mean ~ scale(i), list(i = as.name(x))),
                          data = mean_weather3)})
models_summary<-lapply(X = models, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models_summary<-models_summary[c(1:2,5,6)]
names(models_summary)<-c("variable","Estimate","P","sig")
models_summary<-subset(models_summary,!variable=="(Intercept)")
models_summary<-cbind(models_summary,sapply(lapply(X = models, FUN = summary), "[[", 9))
names(models_summary)[5]<-"Rsquare"
kable(arrange(subset(models_summary,P<0.05),desc(Rsquare)))
```

The model explaining the most variance is still the one with mean daily temperature for April and May,
followed by GDD3 and GDH3 for April and May.  
April and May seems to be the most important period.

## With variance of FFD

```{r Models FFD_var against temperature, precipitation and GDD/GDH,warning=FALSE,message=FALSE}
models1<-lapply(names(mean_weather3)[c(7:9,19:21,31:33,43:45,
        55:57,67:69,79:81,91:93,103:105,115:117,127:129,139:141,146:217)], 
         function(x) {lm(substitute(FFD_var ~ scale(i), list(i = as.name(x))),
                          data = mean_weather3)})
models1_summary<-lapply(X = models1, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models1_summary<-models1_summary[c(1:2,5,6)]
names(models1_summary)<-c("variable","Estimate","P","sig")
models1_summary<-subset(models1_summary,!variable=="(Intercept)")
models1_summary<-cbind(models1_summary,sapply(lapply(X = models1, FUN = summary), "[[", 9))
names(models1_summary)[5]<-"Rsquare"
kable(arrange(subset(models1_summary,P<0.05),desc(Rsquare)))
```

The models explaining the most variance are those with temperatures in April. Also precipitation January-March explains quite a lot. Variance in phenology increases when April is warm and January-March are rainy.

## With range of FFD (duration* of flowering)
*Not including the time that last flowers are open

```{r Models FFD_dur against temperature, precipitation and GDD/GDH,warning=FALSE,message=FALSE}
models2<-lapply(names(mean_weather3)[c(7:9,19:21,31:33,43:45,
        55:57,67:69,79:81,91:93,103:105,115:117,127:129,139:141,146:217)], 
         function(x) {lm(substitute(FFD_dur ~ scale(i), list(i = as.name(x))),
                          data = mean_weather3)})
models2_summary<-lapply(X = models2, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models2_summary<-models2_summary[c(1:2,5,6)]
names(models2_summary)<-c("variable","Estimate","P","sig")
models2_summary<-subset(models2_summary,!variable=="(Intercept)")
models2_summary<-cbind(models2_summary,sapply(lapply(X = models2, FUN = summary), "[[", 9))
names(models2_summary)[5]<-"Rsquare"
kable(arrange(subset(models2_summary,P<0.05),desc(Rsquare)))
```

The models explaining the most variance are those with temperatures in April. Duration of flowering increases when April is warm. Also precipitation in April explains quite a lot, with duration decreasing when April is rainy.

## With skewness of FFD

```{r Models FFD_skew against temperature, precipitation and GDD/GDH,warning=FALSE,message=FALSE}
models3<-lapply(names(mean_weather3)[c(7:9,19:21,31:33,43:45,
        55:57,67:69,79:81,91:93,103:105,115:117,127:129,139:141,146:217)], 
         function(x) {lm(substitute(FFD_skew ~ scale(i), list(i = as.name(x))),
                          data = mean_weather3)})
models3_summary<-lapply(X = models3, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models3_summary<-models3_summary[c(1:2,5,6)]
names(models3_summary)<-c("variable","Estimate","P","sig")
models3_summary<-subset(models3_summary,!variable=="(Intercept)")
models3_summary<-cbind(models3_summary,sapply(lapply(X = models3, FUN = summary), "[[", 9))
names(models3_summary)[5]<-"Rsquare"
kable(arrange(subset(models3_summary,P<0.05),desc(Rsquare)))
```

The models explaining the most variance are those with temperatures in March. The positive skewness of the FFD curve increases when March is cold. This could mean that when March is cold, there is a faster response to warming temperatures, and more plants start flowering in the beginning of the season?

## With kurtosis of FFD

```{r Models FFD_kurt against temperature, precipitation and GDD/GDH,warning=FALSE,message=FALSE}
models4<-lapply(names(mean_weather3)[c(7:9,19:21,31:33,43:45,
        55:57,67:69,79:81,91:93,103:105,115:117,127:129,139:141,146:217)], 
         function(x) {lm(substitute(FFD_kurt ~ scale(i), list(i = as.name(x))),
                          data = mean_weather3)})
models4_summary<-lapply(X = models4, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models4_summary<-models4_summary[c(1:2,5,6)]
names(models4_summary)<-c("variable","Estimate","P","sig")
models4_summary<-subset(models4_summary,!variable=="(Intercept)")
models4_summary<-cbind(models4_summary,sapply(lapply(X = models4, FUN = summary), "[[", 9))
names(models4_summary)[5]<-"Rsquare"
kable(arrange(subset(models4_summary,P<0.05),desc(Rsquare)))
```

No sigificant relationships for FFD_kurt.

## Plots of the best models

```{r Plots of best models FFD, echo=FALSE, fig.height=12, fig.width=8}
grid.arrange(
  ggplot(mean_weather3,aes(x=mean45,y=FFD_mean))+geom_point(size=1)+geom_smooth(method="lm")+
  xlab("Mean daily temperature April and May")+ylab("Mean FFD")+geom_text(x=18,y=70,label="R2=0.76"),
ggplot(mean_weather3,aes(x=prec123,y=FFD_mean))+geom_point(size=1)+geom_smooth(method="lm")+
  xlab("Sum of precipitation January-March")+ylab("Mean FFD")+geom_text(x=200,y=70,label="R2=0.17"),
ggplot(mean_weather3,aes(x=min_4,y=FFD_var))+geom_point(size=1)+geom_smooth(method="lm")+
  xlab("Min daily temperature April")+ylab("Variance FFD")+geom_text(x=2.5,y=50,label="R2=0.47"),
ggplot(mean_weather3,aes(x=prec123,y=FFD_var))+geom_point(size=1)+geom_smooth(method="lm")+
  xlab("Sum of precipitation January-March")+ylab("Variance FFD")+geom_text(x=150,y=50,label="R2=0.39"),
ggplot(mean_weather3,aes(x=mean_4,y=FFD_dur))+geom_point(size=1)+geom_smooth(method="lm")+
  xlab("Mean daily temperature April")+ylab("Range FFD")+geom_text(x=6,y=33,label="R2=0.33"),
ggplot(mean_weather3,aes(x=precipitation_4,y=FFD_dur))+geom_point(size=1)+geom_smooth(method="lm")+
  xlab("Sum of precipitation April")+ylab("Range FFD")+geom_text(x=60,y=30,label="R2=0.24"),
ggplot(mean_weather3,aes(x=max_3,y=FFD_skew))+geom_point(size=1)+geom_smooth(method="lm")+
  xlab("Max daily temperature March")+ylab("Skewness FFD")+geom_text(x=7.5,y=1.45,label="R2=0.22"),
ncol=2)
```

## Models of FFD against temperature AND precipitation 

Adding precipitation does not increase much the R2 

```{r temperature and precipitation}
summary(lm(FFD_mean~mean45+prec123,mean_weather3)) #Increase from 0.76 to 0.77
summary(lm(FFD_var~min_4+prec123,mean_weather3))  #Increase from 0.47 to 0.54
summary(lm(FFD_dur~mean_4+precipitation_4,mean_weather3))  #Increase from 0.33 to 0.37
```

# Calculations cumulated GDD/GDH
Sum of GDD/GDH until each date, with 3 different starting dates:  
- from the start of the year  
- from the vernal equinox  
- from April 15 (or 16) - vernal equinox + 26 days

```{r Calculate cumulated GDD/GDH}
#From the start of the year
weather<-as.data.frame(weather %>% 
         dplyr::group_by(year) %>%
         dplyr::mutate(cumGDD3=cumsum(x = GDD3),cumGDD5=cumsum(x = GDD5),
                cumGDD7=cumsum(x = GDD7),cumGDD10=cumsum(x = GDD10),
                cumGDH3=cumsum(x = GDH3),cumGDH5=cumsum(x = GDH5),
                cumGDH7=cumsum(x = GDH7),cumGDH10=cumsum(x = GDH10)))

#From vernal equinox
weather_vernal<-as.data.frame(subset(weather,period=="b"|period=="c") %>% 
                dplyr::group_by(year) %>%
                dplyr::mutate(cumGDD3v=cumsum(x = GDD3),cumGDD5v=cumsum(x = GDD5),
                       cumGDD7v=cumsum(x = GDD7),cumGDD10v=cumsum(x = GDD10),
                       cumGDH3v=cumsum(x = GDH3),cumGDH5v=cumsum(x = GDH5),
                       cumGDH7v=cumsum(x = GDH7),cumGDH10v=cumsum(x = GDH10)))

#From April 15 (or 16) - vernal equinox + 26 days
weather_apr15<-as.data.frame(subset(weather,date>=vernal+26) %>% 
                dplyr::group_by(year) %>%
                dplyr::mutate(cumGDD3a=cumsum(x = GDD3),cumGDD5a=cumsum(x = GDD5),
                       cumGDD7a=cumsum(x = GDD7),cumGDD10a=cumsum(x = GDD10),
                       cumGDH3a=cumsum(x = GDH3),cumGDH5a=cumsum(x = GDH5),
                       cumGDH7a=cumsum(x = GDH7),cumGDH10a=cumsum(x = GDH10)))
```

Merge with previous data
```{r Merge with other data}
weather$FFD<-weather$date_julian
weather_vernal$FFD<-weather_vernal$date_julian
weather_apr15$FFD<-weather_apr15$date_julian

alldata_weather<-merge(alldata, weather[c(1,6:17,22:30)], all.x=T,all.y=F)
alldata_weather<-merge(alldata_weather,weather_vernal[c(1,30:38)], all.x=T,all.y=F)
alldata_weather<-merge(alldata_weather,weather_apr15[c(1,30:38)], all.x=T,all.y=F)
```

```{r Fix cases where merge by FFD did not work, include=FALSE}
subset(alldata_weather,is.na(mean)&!is.na(FFD)) #Merge by FFD did not work in those

tomerge<-rbind(
merge(merge(subset(weather,FFD>65&FFD<66&year==1992)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>65&FFD<66&year==1992)[c(1,30:38)]),
            subset(weather_apr15,FFD>65&FFD<66&year==1992)[c(1,30:38)]),
merge(merge(subset(weather,FFD>51&FFD<52&year==2006)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>51&FFD<52&year==2006)[c(1,30:38)]),
            subset(weather_apr15,FFD>51&FFD<52&year==2006)[c(1,30:38)]),
merge(merge(subset(weather,FFD>55&FFD<56&year==2006)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>55&FFD<56&year==2006)[c(1,30:38)]),
            subset(weather_apr15,FFD>55&FFD<56&year==2006)[c(1,30:38)]),
merge(merge(subset(weather,FFD>60&FFD<61&year==2006)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>60&FFD<61&year==2006)[c(1,30:38)]),
            subset(weather_apr15,FFD>60&FFD<61&year==2006)[c(1,30:38)]),
merge(merge(subset(weather,FFD>43&FFD<44&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>43&FFD<44&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>43&FFD<44&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>47&FFD<48&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>47&FFD<48&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>47&FFD<48&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>48&FFD<49&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>48&FFD<49&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>48&FFD<49&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>51&FFD<51.3&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>51&FFD<51.3&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>51&FFD<51.3&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>51.3&FFD<53&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>51.3&FFD<53&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>51.3&FFD<53&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>53&FFD<54&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>53&FFD<54&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>53&FFD<54&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>56&FFD<56.3&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>56&FFD<56.3&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>56&FFD<56.3&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>56.3&FFD<58&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>56.3&FFD<58&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>56.3&FFD<58&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>59&FFD<60&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>59&FFD<60&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>59&FFD<60&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>60&FFD<61&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>60&FFD<61&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>60&FFD<61&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>61&FFD<62&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>61&FFD<62&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>61&FFD<62&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>62&FFD<63&year==2007)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>62&FFD<63&year==2007)[c(1,30:38)]),
            subset(weather_apr15,FFD>62&FFD<63&year==2007)[c(1,30:38)]),
merge(merge(subset(weather,FFD>54&FFD<55&year==2009)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>54&FFD<55&year==2009)[c(1,30:38)]),
            subset(weather_apr15,FFD>54&FFD<55&year==2009)[c(1,30:38)]),
merge(merge(subset(weather,FFD>56&FFD<57&year==2010)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>56&FFD<57&year==2010)[c(1,30:38)]),
            subset(weather_apr15,FFD>56&FFD<57&year==2010)[c(1,30:38)]),
merge(merge(subset(weather,FFD>48&FFD<49&year==2011)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>48&FFD<49&year==2011)[c(1,30:38)]),
            subset(weather_apr15,FFD>48&FFD<49&year==2011)[c(1,30:38)]),
merge(merge(subset(weather,FFD>50&FFD<51&year==2011)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>50&FFD<51&year==2011)[c(1,30:38)]),
            subset(weather_apr15,FFD>50&FFD<51&year==2011)[c(1,30:38)]),
merge(merge(subset(weather,FFD>54&FFD<55&year==2011)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>54&FFD<55&year==2011)[c(1,30:38)]),
            subset(weather_apr15,FFD>54&FFD<55&year==2011)[c(1,30:38)]),
merge(merge(subset(weather,FFD>61&FFD<62&year==2011)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>61&FFD<62&year==2011)[c(1,30:38)]),
            subset(weather_apr15,FFD>61&FFD<62&year==2011)[c(1,30:38)]),
merge(merge(subset(weather,FFD>52&FFD<53&year==2012)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>52&FFD<53&year==2012)[c(1,30:38)]),
            subset(weather_apr15,FFD>52&FFD<53&year==2012)[c(1,30:38)]),
merge(merge(subset(weather,FFD>53&FFD<54&year==2012)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>53&FFD<54&year==2012)[c(1,30:38)]),
            subset(weather_apr15,FFD>53&FFD<54&year==2012)[c(1,30:38)]),
merge(merge(subset(weather,FFD>56&FFD<57&year==2012)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>56&FFD<57&year==2012)[c(1,30:38)]),
            subset(weather_apr15,FFD>56&FFD<57&year==2012)[c(1,30:38)]),
merge(merge(subset(weather,FFD>63&FFD<64&year==2012)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>63&FFD<64&year==2012)[c(1,30:38)]),
            subset(weather_apr15,FFD>63&FFD<64&year==2012)[c(1,30:38)]),
merge(merge(subset(weather,FFD>49&FFD<50&year==2014)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>49&FFD<50&year==2014)[c(1,30:38)]),
            subset(weather_apr15,FFD>49&FFD<50&year==2014)[c(1,30:38)]),
merge(merge(subset(weather,FFD>55&FFD<55.8&year==2014)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>55&FFD<55.8&year==2014)[c(1,30:38)]),
            subset(weather_apr15,FFD>55&FFD<55.8&year==2014)[c(1,30:38)]),
merge(merge(subset(weather,FFD>55.8&FFD<57&year==2014)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>55.8&FFD<57&year==2014)[c(1,30:38)]),
            subset(weather_apr15,FFD>55.8&FFD<57&year==2014)[c(1,30:38)]),
merge(merge(subset(weather,FFD>42&FFD<43&year==2015)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>42&FFD<43&year==2015)[c(1,30:38)]),
            subset(weather_apr15,FFD>42&FFD<43&year==2015)[c(1,30:38)]),
merge(merge(subset(weather,FFD>47&FFD<48&year==2015)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>47&FFD<48&year==2015)[c(1,30:38)]),
            subset(weather_apr15,FFD>47&FFD<48&year==2015)[c(1,30:38)]),
merge(merge(subset(weather,FFD>52&FFD<53&year==2015)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>52&FFD<53&year==2015)[c(1,30:38)]),
            subset(weather_apr15,FFD>52&FFD<53&year==2015)[c(1,30:38)]),
merge(merge(subset(weather,FFD>59&FFD<60&year==2015)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>59&FFD<60&year==2015)[c(1,30:38)]),
            subset(weather_apr15,FFD>59&FFD<60&year==2015)[c(1,30:38)]),
merge(merge(subset(weather,FFD>62&FFD<63&year==2015)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>62&FFD<63&year==2015)[c(1,30:38)]),
            subset(weather_apr15,FFD>62&FFD<63&year==2015)[c(1,30:38)]),
merge(merge(subset(weather,FFD>64&FFD<65&year==2017)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>64&FFD<65&year==2017)[c(1,30:38)]),
            subset(weather_apr15,FFD>64&FFD<65&year==2017)[c(1,30:38)]),
merge(merge(subset(weather,FFD>65&FFD<66&year==2017)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>65&FFD<66&year==2017)[c(1,30:38)]),
            subset(weather_apr15,FFD>65&FFD<66&year==2017)[c(1,30:38)]),
merge(merge(subset(weather,FFD>66&FFD<67&year==2017)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>66&FFD<67&year==2017)[c(1,30:38)]),
            subset(weather_apr15,FFD>66&FFD<67&year==2017)[c(1,30:38)]),
merge(merge(subset(weather,FFD>67&FFD<68&year==2017)[c(1,6:17,22:30)],
            subset(weather_vernal,FFD>67&FFD<68&year==2017)[c(1,30:38)]),
            subset(weather_apr15,FFD>67&FFD<68&year==2017)[c(1,30:38)]))

tomerge$FFD_r<-round(tomerge$FFD,2)
alldata_weather$FFD_r<-round(alldata_weather$FFD,2)

head(tomerge)
head(subset(alldata_weather,is.na(mean)&!is.na(FFD))[c(20:39,56)])

#Substitute by hand in OpenOffice Calc NA values in weather columns of alldata_weather by values in tomerge, matching by closest FFD_r value
write.table(alldata_weather,file="C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/alldata_weather.csv",sep="\t",dec=",",col.names=T,row.names=F)
write.table(tomerge,file="C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/tomerge.csv",sep="\t",dec=",",col.names=T,row.names=F)
```

Load new data with some missing values for weather manually substituted in OpenOffice Calc  
(merging by date of FFD did not work in cases where FFD was imputed, because that FFD did not correspond exactly to a "real" date - I merged it manually with the closest value)

```{r Load new data with some missing values for weather manually substituted in OpenOffice Calc}
alldata_weather_subs<-read.table("C:/Users/User/Dropbox/SU/Projects/lathyrus/data/clean/alldata_weather_subs.csv",header=T,sep="\t",dec=",") 
nrow(subset(alldata_weather_subs,is.na(mean)&!is.na(FFD))) #No rows with missing weather data
nrow(subset(alldata_weather_subs,n_fr>n_fl)) #4 cases where n_fruits>n_flowers --> fix again
#Equal n_fl to n_fr
alldata_weather_subs$n_fl<-with(alldata_weather_subs,ifelse(n_fr>n_fl,n_fr,n_fl))
```

# Calculations proportion of plants that have started flowering at each FFD

```{r Calculate proportion of plants flowering at each FFD}
#Number of plants flowering per year at each FFD
alldata_weather_subs$year<-as.factor(alldata_weather_subs$year)
alldata_agg<- aggregate(FFD~cumGDD3+cumGDD5+cumGDD7+cumGDD10+cumGDH3+cumGDH5+cumGDH7+cumGDH10+
                        cumGDD3v+cumGDD5v+cumGDD7v+cumGDD10v+cumGDH3v+cumGDH5v+cumGDH7v+cumGDH10v+
                        cumGDD3a+cumGDD5a+cumGDD7a+cumGDD10a+cumGDH3a+cumGDH5a+cumGDH7a+cumGDH10a+year,
                        data=alldata_weather_subs[c(1:2,4,32:55)],FUN=length)

#Cumulated number of plants flowering per year at each FFD
alldata_agg<-as.data.frame(alldata_agg %>% 
                dplyr::group_by(year) %>%
                dplyr::mutate(n_cum_FFD = cumsum(x = FFD)))

#Calculate proportion of plants flowering per year at each FFD
max_nflowering<-aggregate(n_cum_FFD ~year, data=alldata_agg,FUN=max)
max_nflowering$max_nflowering<-max_nflowering$n_cum_FFD
max_nflowering$n_cum_FFD<-NULL

alldata_agg<-merge(alldata_agg,max_nflowering)
alldata_agg$prop_fl<-alldata_agg$n_cum_FFD/alldata_agg$max_nflowering
```

# Models of proportion of plants that have started flowering against cumulated GDD/GDH

```{r Models prop_fl against cumulated GDD/GDH, warning=FALSE}
#Fit univariate binomial GLMs of prop_fl against each predictor
models5<-lapply(names(alldata_agg)[2:25], 
         function(x) {glm(substitute(prop_fl ~ scale(i), list(i = as.name(x))),
                          family=binomial, data = alldata_agg)})

models5_summary<-lapply(X = models5, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models5_summary<-models5_summary[c(1:2,5,7)]
names(models5_summary)<-c("variable","Estimate","P","sig")
models5_summary<-subset(models5_summary,!variable=="(Intercept)")
models5_summary<-cbind(models5_summary,sapply(lapply(X = models5, FUN = NagelkerkeR2), "[[", 2))
names(models5_summary)[5]<-"Rsquare"
kable(arrange(subset(models5_summary,P<0.05),desc(Rsquare)))
```

The cumulated number of GDH3 and GDD3 (computed from the vernal equinox) are the variables explaining more variation in the proportion of plants that have started flowering 

##Plots of the best models
Some plots of the best models of proportion of plants that have started flowering against cumulated GDD/GDH

```{r Plots of proportion of plants starting flowering against cumulated GDD/GDH 1, echo=FALSE, fig.height=4, fig.width=12}
grid.arrange(ggplot(alldata_agg, aes(x=cumGDH3v, y=n_cum_FFD/max_nflowering,group=year,colour=year))+
  geom_smooth(aes(weight=max_nflowering),method=glm,method.args=c(family="binomial"),se=F)+
  ylab("Proportion of plants that have started flowering")+
  xlab("Cumulated GDH3 from vernal equinox"),
ggplot(alldata_agg, aes(x=cumGDD3v, y=n_cum_FFD/max_nflowering,group=year,colour=year))+
  geom_smooth(aes(weight=max_nflowering),method=glm,method.args=c(family="binomial"),se=F)+
  ylab("Proportion of plants that have started flowering")+
  xlab("Cumulated GDD3 from vernal equinox"),ncol=2)
```

```{r Plots of proportion of plants starting flowering against cumulated GDD/GDH 2, echo=FALSE, fig.height=4, fig.width=12}
grid.arrange(ggplot(alldata_agg, aes(x=cumGDH3a, y=n_cum_FFD/max_nflowering,group=year,colour=year))+
  geom_smooth(aes(weight=max_nflowering),method=glm,method.args=c(family="binomial"),se=F)+
  ylab("Proportion of plants that have started flowering")+
  xlab("Cumulated GDH3 from April 15"),
ggplot(alldata_agg, aes(x=cumGDD3a, y=n_cum_FFD/max_nflowering,group=year,colour=year))+
  geom_smooth(aes(weight=max_nflowering),method=glm,method.args=c(family="binomial"),se=F)+
  ylab("Proportion of plants that have started flowering")+
  xlab("Cumulated GDD3 from April 15"),ncol=2)
```

# Plots for year 1990

Year 1990 shows high values of GDD/GDH  
Some plots to look at these high values

```{r 1990, echo=FALSE}
ggplot(weather,aes(date_julian,mean))+geom_line(size=0.5)+facet_wrap(~year,ncol=6)+ggtitle("Mean temperatures for all years")+
  xlab("Date (number of days since vernal equinox)")+ylab("Mean temperature")+geom_hline(yintercept=5,color="blue")

ggplot(subset(weather,year==1990),aes(date_julian,mean))+geom_line()+ggtitle("1990 temperatures")+
  xlab("Date (number of days since vernal equinox)")+ylab("Mean temperature")+geom_hline(yintercept=5,color="blue")

ggplot(weather,aes(date_julian,cumGDD3))+geom_line()+facet_wrap(~year)+ggtitle("Cumulated GDD3 against julian date")+
  xlab("Date (number of days since vernal equinox)")+ylab("Cumulated GDD3")

weather$year<-as.factor(weather$year)

ggplot(weather,aes(date_julian,GDD3,color=year))+geom_smooth(method="loess",se=F,size=0.5)+xlab("Date (number of days since vernal equinox)")+
  ylab("GDD3")+ggtitle("GDD3 against julian date")+geom_point(size=0.1)

with(mean_weather3,plot(GDD3_123456~as.factor(year),ylab="GDD3 January-June",xlab="year"))

grid.arrange(ggplot(mean_weather3,aes(year,GDD3_1))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD January")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_2))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD February")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_3))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD March")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_4))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD April")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_5))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD May")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_6))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD June")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ncol=2,top="GDD for different months for each year, 1990 in red")

grid.arrange(ggplot(mean_weather3,aes(year,GDD3_123456))+
geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD January-June")+
scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_123))+
geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD January-March")+
scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_34))+
geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD March-April")+
scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_45))+
geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD April-May")+
scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_456))+
geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD April-June")+
scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ncol=2,top="GDD for different periods for each year, 1990 in red")
```

GDD are very high in February and March 1990 - many days above the base temperature in these months.

\newpage
# Chilling temperatures in winter  
Calculate number of days with temperatures below 0 / -5 during winter (winter = 1st of December – day before vernal equinox), as well as mean temperatures and precipitation

```{r Winter}
weather$winter<-as.factor(with(weather,ifelse(month==12|period=="a",1,0)))
#Define winter (=December or January-March till day before vernal equinox)
```

```{r Calculations winter,message=FALSE}
weather$mean_below_0<-with(weather,ifelse(mean<0,1,0))
weather$min_below_0<-with(weather,ifelse(min<0,1,0))
weather$max_below_0<-with(weather,ifelse(max<0,1,0))
weather$mean_below_minus5<-with(weather,ifelse(mean<(-5),1,0))
weather$min_below_minus5<-with(weather,ifelse(min<(-5),1,0))
weather$max_below_minus5<-with(weather,ifelse(max<(-5),1,0))

mean_weather3_w<-plyr::join_all(list(
    aggregate(mean ~ year, data=subset(weather,winter==1), FUN=mean),   #Mean of mean daily temperature
    aggregate(min ~ year, data=subset(weather,winter==1), FUN=mean),    #Mean of min daily temperature
    aggregate(max ~ year, data=subset(weather,winter==1), FUN=mean),    #Mean of max daily temperature
    aggregate(precipitation ~ year, data= subset(weather,winter==1), FUN=sum),#Sum of precipitation
    aggregate(mean_below_0 ~ year,data= subset(weather,winter==1), FUN=sum),  #N days with mean<0
    aggregate(min_below_0 ~ year,data= subset(weather,winter==1), FUN=sum),  #N days with min<0
    aggregate(max_below_0 ~ year,data= subset(weather,winter==1), FUN=sum),  #N days with max<0
    aggregate(mean_below_minus5 ~ year,data= subset(weather,winter==1), FUN=sum), #N days with mean<-5
    aggregate(min_below_minus5 ~ year,data= subset(weather,winter==1), FUN=sum),  #N days with min<-5
    aggregate(max_below_minus5 ~ year,data= subset(weather,winter==1), FUN=sum)), #N days with max<-5
    by = NULL, type = "left", match = "all")

colnames(mean_weather3_w)[2:11]<-paste(colnames(mean_weather3_w)[2:11],"w", sep = "_")

mean_weather4<-merge(mean_weather3,mean_weather3_w) #Merge with previous data
```

# Models FFD against winter variables

## With mean of FFD

```{r Models FFD_mean against winter variables,warning=FALSE,message=FALSE}
models6<-lapply(names(mean_weather4)[c(223:232)], 
         function(x) {lm(substitute(FFD_mean ~ scale(i), list(i = as.name(x))),
                          data = mean_weather4)})
models6_summary<-lapply(X = models6, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models6_summary<-models6_summary[c(1:2,5,6)]
names(models6_summary)<-c("variable","Estimate","P","sig")
models6_summary<-subset(models6_summary,!variable=="(Intercept)")
models6_summary<-cbind(models6_summary,sapply(lapply(X = models6, FUN = summary), "[[", 9))
names(models6_summary)[5]<-"Rsquare"
kable(arrange(subset(models6_summary,P<0.05),desc(Rsquare)))
```

More precipitation and higher temperatures in winter are correlated with earlier flowering.  
More cold days in winter is correlated with later flowering.

## With variance of FFD

```{r Models FFD_var against winter variables,warning=FALSE,message=FALSE}
models7<-lapply(names(mean_weather4)[c(223:232)], 
         function(x) {lm(substitute(FFD_var ~ scale(i), list(i = as.name(x))),
                          data = mean_weather4)})
models7_summary<-lapply(X = models7, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models7_summary<-models7_summary[c(1:2,5,6)]
names(models7_summary)<-c("variable","Estimate","P","sig")
models7_summary<-subset(models7_summary,!variable=="(Intercept)")
models7_summary<-cbind(models7_summary,sapply(lapply(X = models7, FUN = summary), "[[", 9))
names(models7_summary)[5]<-"Rsquare"
kable(arrange(subset(models7_summary,P<0.05),desc(Rsquare)))
```

More precipitation and higher temperatures in winter are correlated with higher variance in FFD.  
More cold days in winter is correlated with lower variance in FFD.

## With range of FFD

```{r Models FFD_dur against winter variables,warning=FALSE,message=FALSE}
models8<-lapply(names(mean_weather4)[c(223:232)], 
         function(x) {lm(substitute(FFD_dur ~ scale(i), list(i = as.name(x))),
                          data = mean_weather4)})
models8_summary<-lapply(X = models8, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models8_summary<-models8_summary[c(1:2,5,6)]
names(models8_summary)<-c("variable","Estimate","P","sig")
models8_summary<-subset(models8_summary,!variable=="(Intercept)")
models8_summary<-cbind(models8_summary,sapply(lapply(X = models8, FUN = summary), "[[", 9))
names(models8_summary)[5]<-"Rsquare"
kable(arrange(subset(models8_summary,P<0.05),desc(Rsquare)))
```

No sigificant relationships for FFD_dur.

## With skewness of FFD

```{r Models FFD_skew against winter variables,warning=FALSE,message=FALSE}
models9<-lapply(names(mean_weather4)[c(223:232)], 
         function(x) {lm(substitute(FFD_skew ~ scale(i), list(i = as.name(x))),
                          data = mean_weather4)})
models9_summary<-lapply(X = models9, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models9_summary<-models9_summary[c(1:2,5,6)]
names(models9_summary)<-c("variable","Estimate","P","sig")
models9_summary<-subset(models9_summary,!variable=="(Intercept)")
models9_summary<-cbind(models9_summary,sapply(lapply(X = models9, FUN = summary), "[[", 9))
names(models9_summary)[5]<-"Rsquare"
kable(arrange(subset(models9_summary,P<0.05),desc(Rsquare)))
```

No sigificant relationships for FFD_skew.

## With kurtosis of FFD

```{r Models FFD_kurt against winter variables,warning=FALSE,message=FALSE}
models10<-lapply(names(mean_weather4)[c(223:232)], 
         function(x) {lm(substitute(FFD_kurt ~ scale(i), list(i = as.name(x))),
                          data = mean_weather4)})
models10_summary<-lapply(X = models10, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models10_summary<-models10_summary[c(1:2,5,6)]
names(models10_summary)<-c("variable","Estimate","P","sig")
models10_summary<-subset(models10_summary,!variable=="(Intercept)")
models10_summary<-cbind(models10_summary,sapply(lapply(X = models10, FUN = summary), "[[", 9))
names(models10_summary)[5]<-"Rsquare"
kable(arrange(subset(models10_summary,P<0.05),desc(Rsquare)))
```

No sigificant relationships for FFD_kurt.

## Plots of the best models

```{r Plots FFD against winter variables,echo=FALSE, fig.height=8, fig.width=10}
grid.arrange(
  ggplot(mean_weather4,aes(x=precipitation_w,y=FFD_mean))+geom_point(size=1)+
    geom_smooth(method="lm")+xlab("Sum of precipitation in winter")+ylab("Mean FFD"),
  ggplot(mean_weather4,aes(x=mean_w,y=FFD_mean))+geom_point(size=1)+
    geom_smooth(method="lm")+xlab("Mean temperature in winter")+ylab("Mean FFD"),
  ggplot(mean_weather4,aes(x=precipitation_w,y=FFD_var))+geom_point(size=1)+
    geom_smooth(method="lm")+xlab("Sum of precipitation in winter")+ylab("Variance FFD"),
  ggplot(mean_weather4,aes(x=min_w,y=FFD_mean))+geom_point(size=1)+
    geom_smooth(method="lm")+xlab("Min temperature in winter")+ylab("Variance FFD")
,ncol=2)
```

# Influence of winter temperature / precipitation in response to spring temperature
Does winter temperature/precipitation influence the response of plants to spring temperature?  
Do fewer days with freezing temperatures/warmer temperatures in winter mean lower sensitivity to increasing spring temperatures?  
Sensitivity to increasing spring temperatures for each year: calculated as the coefficients from yearly models of proportion of plants having started flowering against cumulated number of GDH3 (computed from the vernal equinox) (This was the variable explaining the most variance in the proportion of plants having started flowering)

```{r influence winter temperature on response to spring temperature 1, warning=FALSE}
#Proportion of plants having started flowering
models11<-with(alldata_agg,
            by(alldata_agg, year,
               function(x) glm(prop_fl ~ cumGDH3v, data = x,family=binomial)))
coefs_models11<-as.data.frame(sapply(models11, coef)[2,])
coefs_models11$year<-row.names(coefs_models11)
names(coefs_models11)<-c("resp_cumGDH3v","year")

mean_weather5<-merge(mean_weather4,coefs_models11)

#Fit univariate linear models of resp_cumGDH3v against each winter predictor
models12<-lapply(names(mean_weather5)[c(223:232)], 
         function(x) {lm(substitute(resp_cumGDH3v ~ scale(i), list(i = as.name(x))),
                          data = mean_weather5)})
models12_summary<-lapply(X = models12, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models12_summary<-models12_summary[c(1:2,5,6)]
names(models12_summary)<-c("variable","Estimate","P","sig")
models12_summary<-subset(models12_summary,!variable=="(Intercept)")
models12_summary<-cbind(models12_summary,sapply(lapply(X = models12, FUN = summary), "[[", 9))
names(models12_summary)[5]<-"Rsquare"
kable(arrange(subset(models12_summary,P<0.05),desc(Rsquare)))
```

It seems that only winter precipitation influences the response of plants to increasing spring temperatures (with higher winter precipitation, plants are less responsive to increasing spring temperatures), and the effect is not very strong.  

## Models with effects of mean temperature April and May, measures of chilling and their interaction on mean FFD

Another way of testing the relation among winter conditions and response to spring temperature.

```{r influence winter temperature on response to spring temperature,warning=FALSE,message=FALSE}
#Fit linear models of FFD against mean45*chilling measure
models13<-lapply(names(mean_weather5)[c(223:232)], 
         function(x) {lm(substitute(FFD_mean ~ scale(mean45)*scale(i), list(i = as.name(x))),
                          data = mean_weather5)})
models13_summary<-lapply(X = models13, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models13_summary<-models13_summary[c(1:2,5,6)]
names(models13_summary)<-c("variable","Estimate","P","sig")
models13_summary<-subset(models13_summary,!variable=="(Intercept)")
models13_summary<-cbind(models13_summary,sapply(lapply(X = models13, FUN = summary), "[[", 9))
names(models13_summary)[5]<-"Rsquare"
kable(models13_summary)
```

Interactions are never significant
Test this within years instead of among years?

```{r Save image, include=FALSE}
save.image(file = "C:/Users/User/Dropbox/SU/Projects/lathyrus/code/image1.RData")
```

# SUMMARY
* The mean FFD decreases (earlier flowering) with temperature in April-May and with precipitation in January-March. It also decreases with winter temperature and precipitation.
* The variance in FFD increases with temperature in April and with precipitation in January-March. It also increases with winter precipitation and decreases with winter temperature. 
* The range of FFD increases with temperature in April and decreases with temperature in April
* The skewness of FFD decreases with temperature in March (i.e. higher temperatures in March lead to more left-tailed FFD distributions)
* The proportion of plants having started flowering at a particular date is related to the cumulated number of GDD3/GDH from the vernal equinox
* 1990 shows very high values of GDD/GDH because there were many "warm" days in February and March
* The response of plants to increasing spring temperatures is less strong with higher winter precipitation (but no effect of winter temperature)




